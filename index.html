<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Trends | Prototype</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Supabase JS v2 (CDN) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #f3f4f6;
        --card: #ffffff;
        --border: #e5e7eb;
        --text: #111827;
        --muted: #6b7280;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.12);
        --danger: #ef4444;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Hiragino Sans", "Yu Gothic", sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 16px;
      }

      .app {
        width: 100%;
        max-width: 1120px;
        background: #f9fafb;
        border-radius: 20px;
        border: 1px solid var(--border);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      @media (max-width: 768px) {
        .app {
          border-radius: 16px;
        }
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
        background: #ffffff;
      }

      .brand-main {
        font-size: 18px;
        font-weight: 650;
      }

      .brand-sub {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }

      .topbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .lang-select {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        background: #fff;
      }

      .user-label {
        font-size: 11px;
        color: var(--muted);
      }

      .btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        font-size: 11px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
        transition: background 0.1s ease, box-shadow 0.1s ease,
          transform 0.08s ease;
      }

      .btn.primary {
        border-color: transparent;
        background: linear-gradient(to right, #3b82f6, #60a5fa);
        color: #ffffff;
        font-weight: 600;
        box-shadow: 0 8px 18px rgba(59, 130, 246, 0.35);
      }

      .btn.small {
        padding: 4px 9px;
        font-size: 10px;
      }

      .btn.danger {
        border-color: var(--danger);
        color: var(--danger);
        background: #fef2f2;
      }

      .btn:hover {
        background: #f3f4f6;
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.08);
        transform: translateY(-1px);
      }

      .btn.primary:hover {
        box-shadow: 0 10px 22px rgba(59, 130, 246, 0.45);
      }

      .content {
        display: flex;
        gap: 12px;
        padding: 10px;
      }

      @media (max-width: 768px) {
        .content {
          flex-direction: column;
        }
      }

      .main {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .side {
        flex: 1;
        min-width: 260px;
        max-width: 360px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card {
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--card);
        padding: 10px;
      }

      .section-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .section-sub {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      label {
        font-size: 11px;
        color: var(--muted);
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      input,
      select,
      textarea {
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 6px 7px;
        font-size: 12px;
        outline: none;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent-soft);
      }

      textarea {
        min-height: 60px;
        resize: vertical;
      }

      .field-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }

      .btn-row {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .status {
        margin-top: 6px;
        font-size: 11px;
        color: var(--muted);
      }

      .status.error {
        color: var(--danger);
      }

      .status.ok {
        color: #059669;
      }

      .feed-toolbar {
        margin-bottom: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .feed-filter {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        background: #fff;
      }

      .feed-search {
        flex: 1;
        max-width: 220px;
      }

      .feed-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: calc(100vh - 260px);
        overflow-y: auto;
        padding-right: 4px;
      }

      @media (max-width: 768px) {
        .feed-list {
          max-height: none;
        }
      }

      .post-card {
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #ffffff;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .post-meta-left {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }

      .avatar {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: var(--accent-soft);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: var(--accent);
        flex-shrink: 0;
      }

      .post-meta-texts {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .post-name {
        font-size: 12px;
      }

      .post-sub {
        font-size: 10px;
        color: var(--muted);
      }

      .badge {
        font-size: 10px;
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f9fafb;
        color: var(--muted);
      }

      .badge.public {
        color: var(--accent);
        border-color: var(--accent);
        background: var(--accent-soft);
      }

      .post-body {
        font-size: 12px;
      }

      .post-body strong {
        margin-right: 4px;
      }

      .post-training {
        font-size: 11px;
        color: var(--muted);
      }

      .post-media {
        margin-top: 4px;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border);
        background: #f3f4f6;
      }

      .post-media-inner {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
      }

      .post-media-inner img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .post-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 4px;
      }

      .post-actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .icon-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.08s ease, opacity 0.08s ease;
      }

      .icon-btn:hover {
        transform: translateY(-1px);
        opacity: 0.8;
      }

      .empty {
        font-size: 11px;
        color: var(--muted);
      }

      .hint {
        font-size: 10px;
        color: var(--muted);
        margin-top: 4px;
      }

      .hidden {
        display: none !important;
      }

      /* modal */

      .backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
        padding: 16px;
      }

      .modal {
        width: 100%;
        max-width: 420px;
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.25);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .modal-title {
        font-size: 14px;
        font-weight: 600;
      }

      .close-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 18px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div>
          <div class="brand-main">Trends</div>
          <div class="brand-sub" id="brand-sub">
            Á≠ã„Éà„É¨Â∞ÇÁî®SNS / Feed„É°„Ç§„É≥ / „Ç∑„É≥„Éó„É´Ë®≠Ë®à
          </div>
        </div>
        <div class="topbar-right">
          <select id="lang-select" class="lang-select">
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="en">English</option>
          </select>
          <div class="user-label" id="nav-user-label">Not logged in</div>
          <button class="btn primary" id="btn-open-auth">Log in / Sign up</button>
          <button class="btn hidden" id="btn-logout">Log out</button>
        </div>
      </header>

      <main class="content">
        <!-- main / feed -->
        <section class="main">
          <div class="card">
            <div class="section-title" id="feed-title">Feed</div>
            <div class="section-sub" id="feed-sub">
              „Éà„É¨„Éº„Éã„É≥„Ç∞Ë®òÈå≤„Éª„Éú„Éá„Ç£„ÉÅ„Çß„ÉÉ„ÇØ„Éª„É°„É¢„ÇíÊµÅ„Åó„Å¶„ÅÑ„Åè„Çø„Ç§„É†„É©„Ç§„É≥„ÄÇ
            </div>

            <form id="post-form">
              <div class="field-row">
                <label>
                  <span id="label-date">Date</span>
                  <input type="date" id="post-date" />
                </label>
                <label>
                  <span id="label-bw">Bodyweight (kg)</span>
                  <input
                    type="number"
                    step="0.1"
                    id="post-bodyweight"
                    placeholder="‰æã: 77.4"
                  />
                </label>
              </div>

              <div class="field-row" style="margin-top: 6px">
                <label>
                  <span id="label-visibility">Visibility</span>
                  <select id="post-visibility">
                    <option value="public">Public</option>
                    <option value="private">Private</option>
                  </select>
                </label>
                <label>
                  <span id="label-media">Image URL (optional)</span>
                  <input
                    type="url"
                    id="post-media-url"
                    placeholder="https://..."
                  />
                </label>
              </div>

              <label style="margin-top: 6px">
                <span id="label-caption">Caption / training memo</span>
                <textarea
                  id="post-note"
                  placeholder="bench 100kg 3x3 RPE7..."
                ></textarea>
              </label>

              <div class="btn-row">
                <button class="btn primary" type="submit" id="btn-post">
                  <span id="btn-post-text">Post</span>
                </button>
                <button class="btn" type="button" id="btn-reset">
                  <span id="btn-reset-text">Reset</span>
                </button>
              </div>
              <div class="status" id="post-status"></div>
            </form>
          </div>

          <div class="card">
            <div class="feed-toolbar">
              <select id="feed-filter" class="feed-filter">
                <option value="all">All</option>
                <option value="mine">Mine only</option>
              </select>
              <input
                id="feed-search"
                class="feed-search"
                type="search"
                placeholder="Search caption / handle"
              />
            </div>
            <div class="feed-list" id="feed-list"></div>
            <div class="empty hidden" id="feed-empty">
              No posts yet. Write your first training log üëá
            </div>
          </div>
        </section>

        <!-- side -->
        <aside class="side">
          <div class="card">
            <div class="section-title" id="account-title">Account</div>
            <div class="section-sub" id="account-sub">
              „Ç∑„É≥„Éó„É´„Å™„É°„Éº„É´Ôºã„Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„ÄÇ
            </div>

            <div id="account-logged-out">
              <div class="status">
                <span id="account-logged-out-text">
                  „Åæ„Å†„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                </span>
              </div>
              <div class="btn-row" style="margin-top: 8px">
                <button class="btn primary" id="btn-open-auth-2">
                  Log in / Sign up
                </button>
              </div>
            </div>

            <div id="account-logged-in" class="hidden">
              <div class="status ok" id="account-user-line">
                Logged in
              </div>
              <div class="hint" id="account-hint">
                „É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÊäïÁ®ø„Åß„Åç„Åæ„Åô„ÄÇ
              </div>
              <div class="btn-row" style="margin-top: 8px">
                <button class="btn" id="btn-reload-feed">Reload feed</button>
                <button class="btn danger" id="btn-logout-2">Log out</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="section-title">Tips</div>
            <ul
              class="section-sub"
              style="margin-left: 14px; list-style: disc; margin-bottom: 0"
              id="tips-list"
            >
              <li>ÊØéÊó•„ÅÆ„Éà„É¨„Çí Twitter ÊÑüË¶ö„ÅßË®òÈå≤„ÄÇ</li>
              <li>Ë¶ã„Çâ„Çå„Åü„Åè„Å™„ÅÑÊó•„ÅØ„ÄåPrivate„Äç„ÇíÈÅ∏Êäû„ÄÇ</li>
              <li>„ÇÜ„Åè„ÇÜ„Åè„ÅØ„Ç≥„Éº„ÉÅ„É≥„Ç∞ / DM / È£ü‰∫ãÁÆ°ÁêÜ„ÇÇËøΩÂä†‰∫àÂÆö„ÄÇ</li>
            </ul>
          </div>

          <div class="card">
            <div class="section-title">Debug / Dev</div>
            <div class="section-sub">
              For now everything is intentionally simple so we can move fast.
            </div>
            <button class="btn small danger" id="btn-clear-cache">
              Clear local cache
            </button>
            <div class="hint">
              „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Åå„Éê„Ç∞„Å£„Åü„Çâ„Åì„Åì„ÇíÊäº„Åó„Å¶„Åã„ÇâÂÜçË™≠„ÅøËæº„Åø„ÄÇ
            </div>
          </div>
        </aside>
      </main>
    </div>

    <!-- Auth Modal -->
    <div class="backdrop hidden" id="auth-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="auth-modal-title">
            Log in / Sign up
          </div>
          <button class="close-btn" id="auth-close">‚úï</button>
        </div>
        <form id="auth-form">
          <label>
            Email
            <input
              type="email"
              id="auth-email"
              placeholder="you@example.com"
              autocomplete="email"
              required
            />
          </label>
          <label style="margin-top: 6px">
            Password
            <input
              type="password"
              id="auth-password"
              placeholder="at least 6 characters"
              autocomplete="current-password"
              required
            />
          </label>
          <label style="margin-top: 6px">
            Handle (optional)
            <input
              type="text"
              id="auth-handle"
              placeholder="homare_pwr"
              autocomplete="username"
            />
          </label>
          <div class="btn-row" style="margin-top: 10px">
            <button type="button" class="btn primary" id="btn-login">
              Log in
            </button>
            <button type="button" class="btn" id="btn-signup">
              Sign up
            </button>
          </div>
          <div class="status" id="auth-status"></div>
        </form>
      </div>
    </div>

    <script>
      // ========= Supabase client =========
      const SUPABASE_URL = "https://sfuroqxcljlkbthblqva.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdXJvcXhjbGpsa2J0aGJscXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTE0MTQsImV4cCI6MjA4MDc2NzQxNH0.v1qrjQgkPg3hPjIVCsKg3unwM0lvPGXkw8DvVm8YlRI";

      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ========= DOM refs =========
      const navUserLabel = document.getElementById("nav-user-label");
      const btnOpenAuth = document.getElementById("btn-open-auth");
      const btnOpenAuth2 = document.getElementById("btn-open-auth-2");
      const btnLogout = document.getElementById("btn-logout");
      const btnLogout2 = document.getElementById("btn-logout-2");

      const accountLoggedOut = document.getElementById("account-logged-out");
      const accountLoggedIn = document.getElementById("account-logged-in");
      const accountUserLine = document.getElementById("account-user-line");

      const postForm = document.getElementById("post-form");
      const postDate = document.getElementById("post-date");
      const postBodyweight = document.getElementById("post-bodyweight");
      const postVisibility = document.getElementById("post-visibility");
      const postMediaUrl = document.getElementById("post-media-url");
      const postNote = document.getElementById("post-note");
      const btnReset = document.getElementById("btn-reset");
      const postStatus = document.getElementById("post-status");

      const feedList = document.getElementById("feed-list");
      const feedEmpty = document.getElementById("feed-empty");
      const feedFilter = document.getElementById("feed-filter");
      const feedSearch = document.getElementById("feed-search");

      const btnReloadFeed = document.getElementById("btn-reload-feed");
      const btnClearCache = document.getElementById("btn-clear-cache");

      const authBackdrop = document.getElementById("auth-backdrop");
      const authClose = document.getElementById("auth-close");
      const authForm = document.getElementById("auth-form");
      const authEmail = document.getElementById("auth-email");
      const authPassword = document.getElementById("auth-password");
      const authHandle = document.getElementById("auth-handle");
      const authStatus = document.getElementById("auth-status");
      const btnLogin = document.getElementById("btn-login");
      const btnSignup = document.getElementById("btn-signup");

      const langSelect = document.getElementById("lang-select");

      let currentUser = null;
      let allPosts = [];

      // ========= helpers =========
      function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (Number.isNaN(d.getTime())) return dateStr;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}/${m}/${day}`;
      }

      function formatDateTime(dateStr) {
        const d = new Date(dateStr);
        if (Number.isNaN(d.getTime())) return "";
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${m}/${day} ${hh}:${mm}`;
      }

      function mediaTypeFromUrl(url) {
        if (!url) return null;
        if (url.match(/\.(mp4|mov|webm)$/i)) return "video";
        return "image";
      }

      function showAuthModal() {
        authStatus.textContent = "";
        authBackdrop.classList.remove("hidden");
      }

      function hideAuthModal() {
        authBackdrop.classList.add("hidden");
      }

      // ========= language (very simple) =========
      const TEXTS = {
        ja: {
          brandSub: "Á≠ã„Éà„É¨Â∞ÇÁî®SNS / Feed„É°„Ç§„É≥ / „Ç∑„É≥„Éó„É´Ë®≠Ë®à",
          feedTitle: "Feed",
          feedSub: "„Éà„É¨„Éº„Éã„É≥„Ç∞Ë®òÈå≤„Éª„Éú„Éá„Ç£„ÉÅ„Çß„ÉÉ„ÇØ„Éª„É°„É¢„ÇíÊµÅ„Åô„Çø„Ç§„É†„É©„Ç§„É≥„ÄÇ",
          labelDate: "Êó•‰ªò",
          labelBw: "‰ΩìÈáç (kg)",
          labelVis: "ÂÖ¨ÈñãÁØÑÂõ≤",
          labelMedia: "ÁîªÂÉèURL (‰ªªÊÑè)",
          labelCaption: "„Ç≠„É£„Éó„Ç∑„Éß„É≥ / „Éà„É¨„Éº„Éã„É≥„Ç∞„É°„É¢",
          btnPost: "ÊäïÁ®ø",
          btnReset: "„É™„Çª„ÉÉ„Éà",
          accountTitle: "„Ç¢„Ç´„Ç¶„É≥„Éà",
          accountSub: "„É°„Éº„É´ + „Éë„Çπ„ÉØ„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„ÄÇ",
          accountLoggedOutText: "„Åæ„Å†„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ",
        },
        en: {
          brandSub: "Workout SNS / Feed first / Simple UI",
          feedTitle: "Feed",
          feedSub: "Timeline for training logs, physique shots, and notes.",
          labelDate: "Date",
          labelBw: "Bodyweight (kg)",
          labelVis: "Visibility",
          labelMedia: "Image URL (optional)",
          labelCaption: "Caption / training memo",
          btnPost: "Post",
          btnReset: "Reset",
          accountTitle: "Account",
          accountSub: "Sign in with email + password.",
          accountLoggedOutText: "You are not logged in yet.",
        },
      };

      function applyLanguage(lang) {
        const t = TEXTS[lang] || TEXTS.ja;
        document.getElementById("brand-sub").textContent = t.brandSub;
        document.getElementById("feed-title").textContent = t.feedTitle;
        document.getElementById("feed-sub").textContent = t.feedSub;
        document.getElementById("label-date").textContent = t.labelDate;
        document.getElementById("label-bw").textContent = t.labelBw;
        document.getElementById("label-visibility").textContent = t.labelVis;
        document.getElementById("label-media").textContent = t.labelMedia;
        document.getElementById("label-caption").textContent = t.labelCaption;
        document.getElementById("btn-post-text").textContent = t.btnPost;
        document.getElementById("btn-reset-text").textContent = t.btnReset;
        document.getElementById("account-title").textContent = t.accountTitle;
        document.getElementById("account-sub").textContent = t.accountSub;
        document.getElementById("account-logged-out-text").textContent =
          t.accountLoggedOutText;
      }

      langSelect.addEventListener("change", () => {
        const lang = langSelect.value || "ja";
        applyLanguage(lang);
      });

      // ========= Auth =========
      async function refreshUser() {
        const { data, error } = await client.auth.getUser();
        if (error || !data.user) {
          currentUser = null;
        } else {
          currentUser = data.user;
        }
        updateAuthUI();
      }

      function updateAuthUI() {
        if (currentUser) {
          const handle =
            currentUser.user_metadata?.handle ||
            currentUser.email?.split("@")[0];
          navUserLabel.textContent = `@${handle} / ${currentUser.email}`;
          btnOpenAuth.classList.add("hidden");
          btnOpenAuth2.classList.add("hidden");
          btnLogout.classList.remove("hidden");
          btnLogout2.classList.remove("hidden");
          accountLoggedOut.classList.add("hidden");
          accountLoggedIn.classList.remove("hidden");
          accountUserLine.textContent = `Logged in as @${handle}`;
        } else {
          navUserLabel.textContent = "Not logged in";
          btnOpenAuth.classList.remove("hidden");
          btnOpenAuth2.classList.remove("hidden");
          btnLogout.classList.add("hidden");
          btnLogout2.classList.add("hidden");
          accountLoggedOut.classList.remove("hidden");
          accountLoggedIn.classList.add("hidden");
        }
      }

      btnOpenAuth.addEventListener("click", showAuthModal);
      btnOpenAuth2.addEventListener("click", showAuthModal);
      authClose.addEventListener("click", hideAuthModal);
      authBackdrop.addEventListener("click", (e) => {
        if (e.target === authBackdrop) hideAuthModal();
      });

      btnLogin.addEventListener("click", async () => {
        authStatus.textContent = "";
        const email = authEmail.value.trim();
        const pw = authPassword.value;

        if (!email || !pw) {
          authStatus.textContent = "Email „Å® password „ÅØÂøÖÈ†à„Åß„Åô„ÄÇ";
          authStatus.className = "status error";
          return;
        }

        const { data, error } = await client.auth.signInWithPassword({
          email,
          password: pw,
        });
        if (error) {
          authStatus.textContent = error.message;
          authStatus.className = "status error";
          return;
        }
        authStatus.textContent = "„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü„ÄÇ";
        authStatus.className = "status ok";
        await refreshUser();
        hideAuthModal();
        await loadPosts();
      });

      btnSignup.addEventListener("click", async () => {
        authStatus.textContent = "";
        const email = authEmail.value.trim();
        const pw = authPassword.value;
        const handle = authHandle.value.trim();

        if (!email || !pw) {
          authStatus.textContent = "Email „Å® password „ÅØÂøÖÈ†à„Åß„Åô„ÄÇ";
          authStatus.className = "status error";
          return;
        }

        const { data, error } = await client.auth.signUp({
          email,
          password: pw,
          options: {
            data: {
              handle: handle || email.split("@")[0],
            },
          },
        });

        if (error) {
          authStatus.textContent = error.message;
          authStatus.className = "status error";
          return;
        }

        authStatus.textContent =
          "Sign up ÂÆå‰∫Ü„ÄÇ„ÇÇ„Åó„É°„Éº„É´Á¢∫Ë™ç„ÅåÊúâÂäπ„Å™„Çâ„ÄÅ„É°„Éº„É´„ÅÆ„É™„É≥„ÇØ„ÇÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        authStatus.className = "status ok";

        // „Åô„Åê„É≠„Ç∞„Ç§„É≥„Åï„Åõ„Çã
        const { error: loginError } = await client.auth.signInWithPassword({
          email,
          password: pw,
        });
        if (loginError) {
          authStatus.textContent =
            "Sign up „ÅØÊàêÂäü„Åó„Åæ„Åó„Åü„Åå„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " +
            loginError.message;
          authStatus.className = "status error";
          return;
        }
        await refreshUser();
        hideAuthModal();
        await loadPosts();
      });

      async function doLogout() {
        await client.auth.signOut();
        currentUser = null;
        updateAuthUI();
        await loadPosts();
      }

      btnLogout.addEventListener("click", doLogout);
      btnLogout2.addEventListener("click", doLogout);

      // ========= posts =========
      async function loadPosts() {
        const { data, error } = await client
          .from("posts")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          feedList.innerHTML = "";
          feedEmpty.classList.remove("hidden");
          feedEmpty.textContent =
            "Failed to load posts: " + (error.message || "");
          return;
        }

        allPosts = data || [];
        renderFeed();
      }

      function renderFeed() {
        const filter = feedFilter.value || "all";
        const q = (feedSearch.value || "").trim().toLowerCase();

        let posts = allPosts.slice();

        if (filter === "mine" && currentUser) {
          posts = posts.filter((p) => p.user_id === currentUser.id);
        }

        if (q) {
          posts = posts.filter((p) => {
            const note = (p.note || "").toLowerCase();
            return note.includes(q);
          });
        }

        feedList.innerHTML = "";

        if (posts.length === 0) {
          feedEmpty.classList.remove("hidden");
          return;
        }
        feedEmpty.classList.add("hidden");

        posts.forEach((post) => {
          const card = document.createElement("article");
          card.className = "post-card";

          // header
          const header = document.createElement("div");
          header.className = "post-header";

          const left = document.createElement("div");
          left.className = "post-meta-left";

          const avatar = document.createElement("div");
          avatar.className = "avatar";
          const letter =
            (post.user_id || "U").slice(0, 1).toUpperCase() || "U";
          avatar.textContent = letter;

          const metaTexts = document.createElement("div");
          metaTexts.className = "post-meta-texts";

          const name = document.createElement("div");
          name.className = "post-name";
          name.textContent = post.handle
            ? `@${post.handle}`
            : "@user"; // Â∞ÜÊù•ÁöÑ„Å´ handle „Ç´„É©„É†„ÇíËøΩÂä†„Åó„Å¶„ÇÇOK

          const sub = document.createElement("div");
          sub.className = "post-sub";
          sub.textContent = `${formatDate(post.date)} ¬∑ ${formatDateTime(
            post.created_at
          )}`;

          metaTexts.appendChild(name);
          metaTexts.appendChild(sub);

          left.appendChild(avatar);
          left.appendChild(metaTexts);

          const right = document.createElement("div");
          const badge = document.createElement("div");
          badge.className =
            "badge " + (post.visibility === "public" ? "public" : "");
          badge.textContent =
            post.visibility === "public" ? "Public" : "Private";
          right.appendChild(badge);

          if (currentUser && post.user_id === currentUser.id) {
            const delBtn = document.createElement("button");
            delBtn.className = "btn small";
            delBtn.textContent = "Delete";
            delBtn.addEventListener("click", async () => {
              if (!confirm("Delete this post?")) return;
              const { error } = await client
                .from("posts")
                .delete()
                .eq("id", post.id);
              if (error) {
                alert("Delete failed: " + error.message);
              } else {
                await loadPosts();
              }
            });
            right.appendChild(delBtn);
          }

          header.appendChild(left);
          header.appendChild(right);

          card.appendChild(header);

          // body
          const body = document.createElement("div");
          body.className = "post-body";

          const strong = document.createElement("strong");
          strong.textContent = post.bodyweight
            ? `${post.bodyweight}kg`
            : "Memo";

          body.appendChild(strong);
          body.appendChild(document.createTextNode(post.note || ""));
          card.appendChild(body);

          // media
          if (post.media_url) {
            const media = document.createElement("div");
            media.className = "post-media";
            const inner = document.createElement("div");
            inner.className = "post-media-inner";
            const img = document.createElement("img");
            img.src = post.media_url;
            img.alt = "media";
            inner.appendChild(img);
            media.appendChild(inner);
            card.appendChild(media);
          }

          // footer
          const footer = document.createElement("div");
          footer.className = "post-footer";

          const actions = document.createElement("div");
          actions.className = "post-actions";

          const likeBtn = document.createElement("button");
          likeBtn.className = "icon-btn";
          likeBtn.type = "button";
          likeBtn.textContent = "ü§ç";
          actions.appendChild(likeBtn);

          const metaRight = document.createElement("div");
          metaRight.className = "post-training";
          metaRight.textContent = "";

          footer.appendChild(actions);
          footer.appendChild(metaRight);

          card.appendChild(footer);

          feedList.appendChild(card);
        });
      }

      // ÊäïÁ®øÂá¶ÁêÜ
      postForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        postStatus.textContent = "";
        postStatus.className = "status";

        if (!currentUser) {
          postStatus.textContent = "„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ";
          postStatus.className = "status error";
          showAuthModal();
          return;
        }

        const d = postDate.value;
        const bwStr = postBodyweight.value.trim();
        const vis = postVisibility.value || "public";
        const media = postMediaUrl.value.trim();
        const note = postNote.value.trim();

        if (!d && !note && !bwStr && !media) {
          postStatus.textContent =
            "Êó•‰ªò / ‰ΩìÈáç / „É°„É¢ / ÁîªÂÉèURL „ÅÆ„Å©„Çå„Åã„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
          postStatus.className = "status error";
          return;
        }

        const payload = {
          user_id: currentUser.id,
          date: d || null,
          bodyweight: bwStr ? Number(bwStr) : null,
          note: note || null,
          media_url: media || null,
          media_type: media ? mediaTypeFromUrl(media) : null,
          visibility: vis,
        };

        const { error } = await client.from("posts").insert(payload);

        if (error) {
          console.error(error);
          postStatus.textContent =
            "Error: " + (error.message || "failed to insert");
          postStatus.className = "status error";
          return;
        }

        postStatus.textContent = "ÊäïÁ®ø„Åó„Åæ„Åó„Åü„ÄÇ";
        postStatus.className = "status ok";

        clearPostForm();
        await loadPosts();
      });

      function clearPostForm() {
        const today = new Date().toISOString().slice(0, 10);
        if (!postDate.value) postDate.value = today;
        postBodyweight.value = "";
        postVisibility.value = "public";
        postMediaUrl.value = "";
        postNote.value = "";
      }

      btnReset.addEventListener("click", () => {
        clearPostForm();
        postStatus.textContent = "";
        postStatus.className = "status";
      });

      // reload feed manually
      btnReloadFeed.addEventListener("click", () => {
        loadPosts();
      });

      // clear cache
      btnClearCache.addEventListener("click", async () => {
        await client.auth.signOut();
        localStorage.clear();
        sessionStorage.clear();
        alert("Local cache cleared. Please reload the page.");
      });

      feedFilter.addEventListener("change", renderFeed);
      feedSearch.addEventListener("input", renderFeed);

      // ========= init =========
      async function init() {
        applyLanguage("ja");
        const today = new Date().toISOString().slice(0, 10);
        postDate.value = today;

        await refreshUser();
        await loadPosts();
      }

      init();
    </script>
  </body>
</html>