<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>trends | prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f3f4f6;
      --bg-soft: #f9fafb;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.08);
      --danger: #ef4444;
    }

    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",
        "Hiragino Sans","Yu Gothic",sans-serif;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1120px;
      background: var(--bg-soft);
      border-radius: 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 80vh;
      overflow: hidden;
      box-shadow:
        0 18px 40px rgba(15,23,42,0.06),
        0 0 0 1px rgba(148,163,184,0.1);
    }

    @media (max-width: 768px) {
      body { padding: 8px; }
      .app { min-height: 90vh; border-radius: 16px; }
    }

    /* topbar */

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: #ffffff;
      gap: 8px;
    }

    .brand-main {
      font-size: 16px;
      font-weight: 650;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      max-width: 60%;
    }

    .user-label {
      font-size: 11px;
      color: var(--muted);
      text-align: right;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s ease,border-color 0.1s ease,
        box-shadow 0.1s ease,transform 0.08s ease;
      white-space: nowrap;
    }

    .btn.primary {
      border-color: transparent;
      background: linear-gradient(to right,#3b82f6,#60a5fa);
      color: #ffffff;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(59,130,246,0.35);
    }

    .btn:hover {
      background: #f3f4f6;
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(15,23,42,0.08);
    }

    .btn.primary:hover {
      box-shadow: 0 10px 22px rgba(59,130,246,0.45);
    }

    .btn.small {
      padding: 4px 9px;
      font-size: 10px;
    }

    .btn.danger {
      border-color: var(--danger);
      color: var(--danger);
      background: #fff1f2;
    }

    .hidden { display: none !important; }

    .icon-btn {
      border: none;
      padding: 0;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.08s ease,opacity 0.08s ease;
    }

    .icon-btn:hover {
      transform: translateY(-1px);
      opacity: 0.8;
    }

    .lang-select {
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      padding: 4px 8px;
      background: #ffffff;
    }

    /* layout */

    .content-layout {
      flex: 1;
      display: flex;
      gap: 12px;
      padding: 10px;
      overflow: hidden;
    }

    .feed-column {
      flex: 2;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .side-column {
      flex: 1.2;
      min-width: 260px;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (max-width: 768px) {
      .content-layout {
        flex-direction: column;
      }
      .side-column {
        max-width: 100%;
        min-width: 0;
      }
    }

    .section-header {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-header-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    .section-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .card {
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 8px;
    }

    .card.tight {
      padding: 6px;
    }

    .status {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .empty {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* feed */

    .feed-header-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 4px;
    }

    .feed-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .feed-filter-select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 11px;
      outline: none;
    }

    .feed-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: calc(100vh - 220px);
      overflow-y: auto;
      padding-right: 4px;
    }

    @media (max-width: 768px) {
      .feed-list {
        max-height: none;
      }
    }

    .post-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .post-meta-left {
      display: flex;
      gap: 8px;
      align-items: center;
      min-width: 0;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      flex-shrink: 0;
    }

    .post-meta-texts {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .post-name {
      font-size: 12px;
      display: flex;
      gap: 6px;
      align-items: baseline;
    }

    .post-handle {
      font-size: 11px;
      color: var(--muted);
    }

    .post-sub {
      font-size: 10px;
      color: var(--muted);
    }

    .pill-row {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #f9fafb;
    }

    .badge.type {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .post-body {
      font-size: 12px;
    }

    .post-body strong {
      margin-right: 4px;
    }

    .post-training {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .post-media {
      margin-top: 4px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #f3f4f6;
    }

    .post-media-inner {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
    }

    .post-media-inner img,
    .post-media-inner video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-media-placeholder {
      position: absolute;
      inset: 0;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      text-align: center;
      padding: 0 8px;
    }

    .post-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }

    .post-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .likes-text {
      font-size: 11px;
      color: var(--muted);
    }

    /* comments */

    .comments-section {
      border-top: 1px solid var(--border);
      margin-top: 6px;
      padding-top: 4px;
    }

    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-height: 80px;
      overflow-y: auto;
      padding-right: 2px;
      margin-bottom: 4px;
    }

    .comment-item {
      font-size: 11px;
    }

    .comment-meta {
      font-size: 10px;
      color: var(--muted);
    }

    .comment-form {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .comment-form input {
      flex: 1;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    /* side tabs */

    .side-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .side-tab-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      white-space: nowrap;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .side-tab-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .side-section {
      display: none;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
    }

    .side-section.active {
      display: flex;
    }

    .side-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .side-section-sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    /* fields */

    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    input,
    select,
    textarea {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px 7px;
      color: var(--text);
      font-size: 12px;
      outline: none;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 120px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .hint {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    /* simple list */

    .simple-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 2px;
      margin-top: 4px;
    }

    .meal-item {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px;
      font-size: 11px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .meal-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }

    .tag-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f3f4f6;
      color: var(--muted);
    }

    .meal-main {
      font-size: 11px;
    }

    .meal-meta {
      font-size: 10px;
      color: var(--muted);
    }

    .food-result {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
      font-size: 11px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .food-result-top {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
    }

    .food-macro {
      font-size: 10px;
      color: var(--muted);
    }

    .meal-summary {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px;
      background: #ffffff;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .meal-summary-main {
      font-weight: 600;
    }

    .meal-summary-sub {
      font-size: 10px;
      color: var(--muted);
    }

    .meal-summary-bar {
      margin-top: 2px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #f3f4f6;
      overflow: hidden;
    }

    .meal-summary-bar-inner {
      height: 100%;
      border-radius: 999px;
      background: var(--accent);
    }

    /* Gyms */

    .gym-item {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px;
      font-size: 11px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .gym-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }

    .gym-main {
      font-size: 11px;
    }

    .gym-meta {
      font-size: 10px;
      color: var(--muted);
    }

    .rating-stars {
      font-size: 11px;
      color: #f59e0b;
    }

    /* Messages */

    .chat-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 0;
      max-height: 280px;
    }

    .chat-header {
      font-size: 12px;
      font-weight: 600;
    }

    .chat-sub {
      font-size: 10px;
      color: var(--muted);
    }

    .chat-thread {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-right: 2px;
      margin-top: 2px;
    }

    .msg {
      max-width: 80%;
      padding: 6px 8px;
      border-radius: 9px;
      border: 1px solid var(--border);
      font-size: 11px;
    }

    .msg.me {
      align-self: flex-end;
      background: #eff6ff;
      border-color: #bfdbfe;
    }

    .msg.other {
      align-self: flex-start;
      background: #f9fafb;
    }

    .msg-meta {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .chat-input-row {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .chat-input-row textarea {
      flex: 1;
      min-height: 40px;
      max-height: 80px;
    }

    .conv-list {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .conv-pill {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      cursor: pointer;
      color: var(--muted);
    }

    .conv-pill.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    /* Settings */

    .settings-item {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px;
      font-size: 11px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .settings-title {
      font-weight: 600;
    }

    .people-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 160px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .people-item {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .people-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .people-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .people-sub {
      font-size: 10px;
      color: var(--muted);
    }

    .pill-follow {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f3f4f6;
      color: var(--muted);
      align-self: flex-start;
    }

    .fab {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 48px;
      height: 48px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#3b82f6,#60a5fa);
      color: #ffffff;
      font-size: 26px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 18px 40px rgba(37,99,235,0.4);
      z-index: 20;
    }

    @media (max-width: 768px) {
      .fab {
        right: 16px;
        bottom: 16px;
      }
    }

    /* training sets */

    .training-set-row {
      display: grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1fr) repeat(2,minmax(0,1fr)) minmax(0,1fr) auto;
      gap: 4px;
      margin-top: 4px;
    }

    .training-set-row input,
    .training-set-row select {
      font-size: 11px;
      padding: 4px 6px;
    }

    .training-set-remove {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
    }

    /* modal */

    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }

    .modal {
      width: 100%;
      max-width: 460px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.25);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      color: var(--muted);
    }

    /* search modal */

    .search-input {
      width: 100%;
      margin-bottom: 6px;
    }

    .search-section-title {
      font-size: 11px;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 2px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-main">trends</div>
        <div class="brand-sub" data-i18n="brandSub">ã‚·ãƒ³ãƒ—ãƒ«ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°SNS</div>
      </div>
      <div class="topbar-right">
        <button class="icon-btn" id="btn-open-search" title="Search">
          ğŸ”
        </button>
        <select id="lang-select" class="lang-select">
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="en">English</option>
        </select>
        <div class="user-label" id="nav-user-label">
          æœªãƒ­ã‚°ã‚¤ãƒ³ / ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã ã‘ã§ä¿å­˜
        </div>
        <button class="btn primary" id="btn-open-auth" data-i18n="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²</button>
        <button class="btn hidden" id="btn-logout" data-i18n="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </header>

    <div class="content-layout">
      <!-- Feed column -->
      <section class="feed-column">
        <div>
          <div class="section-header">
            <span class="section-header-dot"></span>
            <span data-i18n="feedTitle">Feed</span>
          </div>
          <div class="section-sub" data-i18n="feedSub">
            ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨Physiqueã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
          </div>
        </div>

        <div class="card">
          <div class="feed-header-row">
            <div class="feed-toolbar">
              <div class="status" id="feed-status">
                ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨æŠ•ç¨¿ã‚’ä¿å­˜ã§ãã¾ã™ã€‚
              </div>
              <select id="feed-filter" class="feed-filter-select">
                <option value="mine">è‡ªåˆ†</option>
                <option value="following">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ï¼‹è‡ªåˆ†</option>
                <option value="all">ã™ã¹ã¦</option>
                <option value="bookmarks">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</option>
              </select>
            </div>
          </div>
          <div class="feed-list" id="feed-list"></div>
          <div class="empty hidden" id="feed-empty">
            ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸‹ã®ã€Œï¼‹ã€ã‹ã‚‰æŠ•ç¨¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      </section>

      <!-- Side column -->
      <aside class="side-column">
        <div class="side-tabs">
          <button class="side-tab-btn active" data-section="meals">
            <span data-i18n="tabMeals">Meals ğŸš</span>
          </button>
          <button class="side-tab-btn" data-section="gyms">
            <span data-i18n="tabGyms">Gyms ğŸ‹ï¸</span>
          </button>
          <button class="side-tab-btn" data-section="messages">
            <span data-i18n="tabMessages">Messages ğŸ’¬</span>
          </button>
          <button class="side-tab-btn" data-section="settings">
            <span data-i18n="tabSettings">Settings âš™ï¸</span>
          </button>
        </div>

        <!-- Meals -->
        <section class="side-section active" id="side-meals">
          <div class="side-section-title" data-i18n="mealsTitle">Meals</div>
          <div class="side-section-sub" data-i18n="mealsSub">
            æ—¥ä»˜ã”ã¨ã®ç°¡å˜ãªé£Ÿäº‹ãƒ­ã‚°ã€‚
          </div>

          <div class="card tight">
            <div class="field-row">
              <label>
                æ—¥ä»˜
                <input type="date" id="meal-date" />
              </label>
              <label>
                ã‚¿ã‚¤ãƒŸãƒ³ã‚°
                <select id="meal-time">
                  <option value="æœ">æœã”ã¯ã‚“</option>
                  <option value="æ˜¼">æ˜¼ã”ã¯ã‚“</option>
                  <option value="å¤œ">å¤œã”ã¯ã‚“</option>
                  <option value="é–“é£Ÿ">é–“é£Ÿ / ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³</option>
                </select>
              </label>
            </div>
            <div class="field-row" style="margin-top:4px;">
              <label>
                é£Ÿã¹ç‰©ã‚’æ¤œç´¢
                <input type="text" id="meal-food-search" placeholder="ä¾‹: ã”ã¯ã‚“ / é¶èƒ¸ / ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³" />
              </label>
              <div style="display:flex;flex-direction:column;align-items:flex-start;gap:4px;">
                <button class="btn small" id="meal-food-search-btn" type="button" style="margin-top:auto;">æ¤œç´¢</button>
              </div>
            </div>
            <div class="simple-list" id="meal-food-results"></div>
            <div class="status" id="meal-status"></div>
          </div>

          <div class="card tight">
            <div class="side-section-sub" style="margin-bottom:2px;">
              é¸æŠã—ãŸæ—¥ã®é£Ÿäº‹ã¨åˆè¨ˆ
            </div>
            <div id="meal-list" class="simple-list"></div>
            <div class="empty hidden" id="meal-empty">
              ã¾ã ã“ã®æ—¥ã®é£Ÿäº‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
            </div>
          </div>
        </section>

        <!-- Gyms -->
        <section class="side-section" id="side-gyms">
          <div class="side-section-title" data-i18n="gymsTitle">Gyms</div>
          <div class="side-section-sub" data-i18n="gymsSub">
            ã‚ˆãè¡Œãã‚¸ãƒ ã®ãƒ¡ãƒ¢ãƒ»è©•ä¾¡ã€‚
          </div>

          <div class="card tight">
            <div class="field-row">
              <label>
                ã‚¸ãƒ å
                <input type="text" id="gym-name" placeholder="ä¾‹: â—‹â—‹ã‚¸ãƒ  æ–°å®¿åº—" />
              </label>
              <label>
                è©•ä¾¡
                <select id="gym-rating">
                  <option value="">ãªã—</option>
                  <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
                  <option value="4">â˜…â˜…â˜…â˜…</option>
                  <option value="3">â˜…â˜…â˜…</option>
                  <option value="2">â˜…â˜…</option>
                  <option value="1">â˜…</option>
                </select>
              </label>
            </div>
            <label style="margin-top:4px;">
              ãƒ¡ãƒ¢
              <textarea id="gym-note" placeholder="ãƒ©ãƒƒã‚¯ã®æ•°ãƒ»é›°å›²æ°—ãƒ»æ–™é‡‘ãªã©"></textarea>
            </label>
            <div class="btn-row">
              <button class="btn small" id="gym-save" type="button">ä¿å­˜ / ä¸Šæ›¸ã</button>
              <button class="btn small" id="gym-clear" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="status" id="gym-status"></div>
          </div>

          <div class="card tight">
            <label>
              ã‚¸ãƒ åã§æ¤œç´¢
              <input type="text" id="gym-search" placeholder="ä¾‹: æ–°å®¿ / Anytime" />
            </label>
            <div class="simple-list" id="gym-list"></div>
            <div class="empty hidden" id="gym-empty">
              ã¾ã ã‚¸ãƒ ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
            </div>
          </div>
        </section>

        <!-- Messages -->
        <section class="side-section" id="side-messages">
          <div class="side-section-title" data-i18n="messagesTitle">Messages</div>
          <div class="side-section-sub" data-i18n="messagesSub">
            ã‚³ãƒ¼ãƒãƒ»ä»²é–“ãƒ»è‡ªåˆ†ç”¨ãƒ¡ãƒ¢ã®ç°¡æ˜“ãƒãƒ£ãƒƒãƒˆã€‚
          </div>

          <div class="conv-list" id="conv-list"></div>

          <div class="chat-card">
            <div class="chat-header" id="chat-title">ä¼šè©±ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <div class="chat-sub" id="chat-sub">
              ä¸Šã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰é¸ã¶ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>
            <div class="chat-thread" id="chat-thread"></div>
            <div class="chat-input-row">
              <textarea id="chat-input" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã"></textarea>
              <button class="btn primary small" id="chat-send" type="button">é€ä¿¡</button>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section class="side-section" id="side-settings">
          <div class="side-section-title" data-i18n="settingsTitle">Settings</div>
          <div class="side-section-sub" data-i18n="settingsSub">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ / ãƒ•ã‚©ãƒ­ãƒ¼ / ãƒ—ãƒ©ãƒ³ / ãƒ†ãƒ¼ãƒ / ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã€‚
          </div>

          <div class="settings-item">
            <div class="settings-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
            <div class="status" id="settings-account-text">
              æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚
            </div>
            <button class="btn small" id="settings-open-auth" type="button">
              ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²
            </button>
          </div>

          <div class="settings-item">
            <div class="settings-title">People & Followers</div>
            <div class="status" id="people-summary">
              ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¨ãƒ•ã‚©ãƒ­ãƒ¼è¨­å®šã€‚
            </div>
            <div class="people-list" id="people-list"></div>
          </div>

          <div class="settings-item">
            <div class="settings-title">ãƒ—ãƒ©ãƒ³ & Pro æ©Ÿèƒ½</div>
            <div class="status" id="plan-status">
              ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãƒ—ãƒ©ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã™ã€‚
            </div>
            <div class="btn-row">
              <button class="btn small" id="btn-plan-free" type="button">Free</button>
              <button class="btn small" id="btn-plan-pro" type="button">Pro</button>
            </div>
            <label style="margin-top:4px;">
              1æ—¥ã®ç›®æ¨™ã‚«ãƒ­ãƒªãƒ¼ (kcal)
              <input type="number" id="cal-target" placeholder="ä¾‹: 2500" />
            </label>
          </div>

          <div class="settings-item">
            <div class="settings-title">ãƒ†ãƒ¼ãƒ</div>
            <label>
              ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
              <select id="theme-select">
                <option value="light">Lightï¼ˆé’ï¼‰</option>
                <option value="sakura">Sakuraï¼ˆãƒ”ãƒ³ã‚¯ï¼‰</option>
                <option value="mint">Mintï¼ˆã‚°ãƒªãƒ¼ãƒ³ï¼‰</option>
              </select>
            </label>
          </div>

          <div class="settings-item">
            <div class="settings-title" style="color:var(--danger);">
              å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            </div>
            <div class="status">
              ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚
            </div>
            <button class="btn small danger" id="btn-clear-all" type="button">
              âš  å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            </button>
            <div class="status" id="clear-status"></div>
          </div>
        </section>
      </aside>
    </div>

    <button class="fab" id="fab-post">ï¼‹</button>
  </div>

  <!-- Auth Modal -->
  <div class="backdrop hidden" id="auth-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" data-i18n="authTitle">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</div>
        <button class="close-btn" id="auth-close">âœ•</button>
      </div>
      <form id="auth-form">
        <div class="field-row">
          <label>
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            <input type="email" id="auth-email" placeholder="you@example.com" autocomplete="email" />
          </label>
          <label>
            ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ 
            <input type="text" id="auth-handle" placeholder="homare_pwr" autocomplete="username" />
          </label>
        </div>
        <label style="margin-top:4px;">
          ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          <input type="password" id="auth-password" placeholder="8æ–‡å­—ä»¥ä¸Šæ¨å¥¨" autocomplete="current-password" />
        </label>
        <div class="hint">
          åˆå›ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã€2å›ç›®ä»¥é™ã¯ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ï¼‰ã€‚
        </div>
        <div class="btn-row">
          <button class="btn primary" type="submit">OK</button>
          <button class="btn small" id="auth-fill-demo" type="button">ãƒ†ã‚¹ãƒˆç”¨å…¥åŠ›</button>
        </div>
        <div class="status" id="auth-status"></div>
      </form>
    </div>
  </div>

  <!-- Post Modal -->
  <div class="backdrop hidden" id="post-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">æ–°ã—ã„æŠ•ç¨¿</div>
        <button class="close-btn" id="post-close">âœ•</button>
      </div>
      <form id="post-form">
        <div class="field-row">
          <label>
            æ—¥ä»˜
            <input type="date" id="post-date" />
          </label>
          <label>
            ä½“é‡ (kg)
            <input type="number" step="0.1" id="post-bodyweight" placeholder="ä¾‹: 77.4" />
          </label>
        </div>

        <label style="margin-top:4px;">
          ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒãƒˆ
          <div id="training-sets"></div>
          <button class="btn small" id="btn-add-set" type="button" style="margin-top:4px;">
            ï¼‹ ã‚»ãƒƒãƒˆè¿½åŠ 
          </button>
        </label>

        <div class="field-row" style="margin-top:4px;">
          <label>
            å…¬é–‹ç¯„å›²
            <select id="post-visibility">
              <option value="public">å…¨å“¡</option>
              <option value="followers">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ã¿</option>
              <option value="close">è¦ªã—ã„å‹é”ã®ã¿</option>
              <option value="private">è‡ªåˆ†ã ã‘</option>
            </select>
          </label>
          <label>
            ç”»åƒ / å‹•ç”»ï¼ˆä»»æ„ï¼‰
            <input type="file" id="post-media-file" accept="image/*,video/*" />
          </label>
        </div>

        <label style="margin-top:4px;">
          ãƒ¡ãƒ¢ / ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
          <textarea id="post-note" placeholder="ãƒ•ã‚©ãƒ¼ãƒ ã®æ„Ÿæƒ³ã€æ¬¡ã®èª²é¡Œã€ä»Šæ—¥ã®æ°—åˆ†ãªã©"></textarea>
        </label>

        <div class="btn-row">
          <button class="btn primary" type="submit">æŠ•ç¨¿ã™ã‚‹</button>
          <button class="btn" id="post-clear" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="status" id="post-status"></div>
      </form>
    </div>
  </div>

  <!-- Search Modal -->
  <div class="backdrop hidden" id="search-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">æ¤œç´¢</div>
        <button class="close-btn" id="search-close">âœ•</button>
      </div>
      <input
        id="search-input"
        class="search-input"
        type="text"
        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»æŠ•ç¨¿ã‚’æ¤œç´¢"
      />
      <div id="search-results" class="simple-list"></div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="backdrop hidden" id="profile-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="profile-title">@someone</div>
        <button class="close-btn" id="profile-close">âœ•</button>
      </div>
      <div class="status" id="profile-sub"></div>
      <div id="profile-summary" class="simple-list"></div>
      <div class="side-section-sub" style="margin-top:4px;">
        ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿
      </div>
      <div id="profile-posts" class="simple-list" style="max-height:260px;overflow-y:auto;"></div>
    </div>
  </div>

  <script>
    (function () {
      // ---- storage keys ----
      const STORAGE_USERS_KEY = "wsns_users";
      const STORAGE_CURRENT_USER_KEY = "wsns_current_user";
      const STORAGE_POSTS_KEY = "wsns_posts";
      const STORAGE_CONVS_KEY = "wsns_conversations";
      const STORAGE_MEALS_KEY = "wsns_meals";
      const STORAGE_GYMS_KEY = "wsns_gyms";
      const STORAGE_THEME_KEY = "wsns_theme";
      const STORAGE_LANG_KEY = "wsns_lang";

      // ---- themes ----
      const THEMES = {
        light: {
          "--bg": "#f3f4f6",
          "--bg-soft": "#f9fafb",
          "--card": "#ffffff",
          "--border": "#e5e7eb",
          "--text": "#111827",
          "--muted": "#6b7280",
          "--accent": "#3b82f6",
          "--accent-soft": "rgba(59,130,246,0.08)",
          "--danger": "#ef4444",
        },
        sakura: {
          "--bg": "#fff1f2",
          "--bg-soft": "#fdf2f8",
          "--card": "#ffffff",
          "--border": "#fecdd3",
          "--text": "#4a044e",
          "--muted": "#9d174d",
          "--accent": "#ec4899",
          "--accent-soft": "rgba(236,72,153,0.12)",
          "--danger": "#b91c1c",
        },
        mint: {
          "--bg": "#ecfdf5",
          "--bg-soft": "#f0fdf4",
          "--card": "#ffffff",
          "--border": "#bbf7d0",
          "--text": "#064e3b",
          "--muted": "#047857",
          "--accent": "#22c55e",
          "--accent-soft": "rgba(34,197,94,0.12)",
          "--danger": "#b91c1c",
        },
      };

      function applyTheme(name) {
        const theme = THEMES[name] || THEMES.light;
        Object.entries(theme).forEach(([k, v]) => {
          document.documentElement.style.setProperty(k, v);
        });
        localStorage.setItem(STORAGE_THEME_KEY, name);
      }

      // ---- i18n (æœ€å°æ§‹æˆã€‚å¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã›ã‚‹) ----
      const I18N = {
        ja: {
          brandSub: "ã‚·ãƒ³ãƒ—ãƒ«ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°SNS",
          loginBtn: "ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²",
          logoutBtn: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
          feedTitle: "Feed",
          feedSub: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨Physiqueã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³",
          tabMeals: "Meals ğŸš",
          tabGyms: "Gyms ğŸ‹ï¸",
          tabMessages: "Messages ğŸ’¬",
          tabSettings: "Settings âš™ï¸",
          mealsTitle: "Meals",
          mealsSub: "æ—¥ä»˜ã”ã¨ã®ç°¡å˜ãªé£Ÿäº‹ãƒ­ã‚°ã€‚",
          gymsTitle: "Gyms",
          gymsSub: "ã‚ˆãè¡Œãã‚¸ãƒ ã®ãƒ¡ãƒ¢ãƒ»è©•ä¾¡ã€‚",
          messagesTitle: "Messages",
          messagesSub: "ã‚³ãƒ¼ãƒãƒ»ä»²é–“ãƒ»è‡ªåˆ†ç”¨ãƒ¡ãƒ¢ã®ç°¡æ˜“ãƒãƒ£ãƒƒãƒˆã€‚",
          settingsTitle: "Settings",
          settingsSub: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ / ãƒ•ã‚©ãƒ­ãƒ¼ / ãƒ—ãƒ©ãƒ³ / ãƒ†ãƒ¼ãƒ / ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã€‚",
          authTitle: "ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²",
        },
        en: {
          brandSub: "Simple training SNS",
          loginBtn: "Log in / Sign up",
          logoutBtn: "Log out",
          feedTitle: "Feed",
          feedSub: "Timeline for training and physique",
          tabMeals: "Meals ğŸš",
          tabGyms: "Gyms ğŸ‹ï¸",
          tabMessages: "Messages ğŸ’¬",
          tabSettings: "Settings âš™ï¸",
          mealsTitle: "Meals",
          mealsSub: "Simple meal log by date.",
          gymsTitle: "Gyms",
          gymsSub: "Notes and ratings for your gyms.",
          messagesTitle: "Messages",
          messagesSub: "Lightweight chat for coach / friends / self-memo.",
          settingsTitle: "Settings",
          settingsSub: "Account / follows / plan / theme / data wipe.",
          authTitle: "Log in / Sign up",
        },
      };

      function applyLanguage(lang) {
        const dict = I18N[lang] || I18N.ja;
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (dict[key]) {
            el.textContent = dict[key];
          }
        });
        localStorage.setItem(STORAGE_LANG_KEY, lang);
      }

      function loadLanguage() {
        const saved = localStorage.getItem(STORAGE_LANG_KEY) || "ja";
        return saved === "en" ? "en" : "ja";
      }

      // ---- food DB (ç°¡æ˜“ç‰ˆ / 1é£Ÿåˆ†ã®ç›®å®‰) ----
      const FOOD_DB = [
        { name: "ã”ã¯ã‚“ï¼ˆèŒ¶ç¢—1æ¯ 200gï¼‰", kcal: 330, protein: 6, fat: 1, carbs: 72 },
        { name: "é¶ã‚€ã­è‚‰ï¼ˆçš®ãªã— 150gï¼‰", kcal: 250, protein: 45, fat: 5, carbs: 0 },
        { name: "é¶ã‚‚ã‚‚è‚‰ï¼ˆçš®ã‚ã‚Š 150gï¼‰", kcal: 350, protein: 30, fat: 25, carbs: 0 },
        { name: "ç‰›ã‚‚ã‚‚ã‚¹ãƒ†ãƒ¼ã‚­ 150g", kcal: 330, protein: 30, fat: 20, carbs: 0 },
        { name: "ã‚µãƒ¼ãƒ¢ãƒ³åˆ‡ã‚Šèº« 120g", kcal: 250, protein: 24, fat: 16, carbs: 0 },
        { name: "ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã‚·ã‚§ã‚¤ã‚¯ 1æ¯ï¼ˆ30gï¼‰", kcal: 120, protein: 24, fat: 2, carbs: 3 },
        { name: "åµ 2å€‹", kcal: 150, protein: 13, fat: 11, carbs: 1 },
        { name: "ãƒãƒŠãƒŠ 1æœ¬", kcal: 90, protein: 1, fat: 0, carbs: 23 },
        { name: "ã‚ªãƒ¼ãƒˆãƒŸãƒ¼ãƒ« 50g", kcal: 190, protein: 7, fat: 3, carbs: 33 },
        { name: "ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ 150gï¼ˆç„¡ç³–ï¼‰", kcal: 90, protein: 7, fat: 3, carbs: 10 },
        { name: "é¶ã‚€ã­è‚‰ + ã”ã¯ã‚“ã‚»ãƒƒãƒˆ", kcal: 580, protein: 50, fat: 6, carbs: 72 },
        { name: "ãƒ©ãƒ¼ãƒ¡ãƒ³ 1æ¯", kcal: 650, protein: 20, fat: 25, carbs: 80 },
        { name: "ç‰›ä¸¼ ä¸¦", kcal: 700, protein: 25, fat: 23, carbs: 95 },
      ];

      // ---- DOM refs ----
      const navUserLabel = document.getElementById("nav-user-label");
      const btnOpenAuth = document.getElementById("btn-open-auth");
      const btnLogout = document.getElementById("btn-logout");
      const langSelect = document.getElementById("lang-select");
      const btnOpenSearch = document.getElementById("btn-open-search");

      // side tabs
      const sideTabBtns = document.querySelectorAll(".side-tab-btn");
      const sideSections = document.querySelectorAll(".side-section");

      // feed
      const feedStatus = document.getElementById("feed-status");
      const feedList = document.getElementById("feed-list");
      const feedEmpty = document.getElementById("feed-empty");
      const feedFilter = document.getElementById("feed-filter");

      // auth
      const authBackdrop = document.getElementById("auth-backdrop");
      const authClose = document.getElementById("auth-close");
      const authForm = document.getElementById("auth-form");
      const authEmail = document.getElementById("auth-email");
      const authHandle = document.getElementById("auth-handle");
      const authPassword = document.getElementById("auth-password");
      const authStatus = document.getElementById("auth-status");
      const authFillDemo = document.getElementById("auth-fill-demo");

      // post
      const postBackdrop = document.getElementById("post-backdrop");
      const postClose = document.getElementById("post-close");
      const postForm = document.getElementById("post-form");
      const postDate = document.getElementById("post-date");
      const postBodyweight = document.getElementById("post-bodyweight");
      const postVisibility = document.getElementById("post-visibility");
      const postMediaFile = document.getElementById("post-media-file");
      const postNote = document.getElementById("post-note");
      const postClear = document.getElementById("post-clear");
      const postStatus = document.getElementById("post-status");
      const trainingSetsContainer = document.getElementById("training-sets");
      const btnAddSet = document.getElementById("btn-add-set");
      const fabPost = document.getElementById("fab-post");

      // Meals
      const mealDate = document.getElementById("meal-date");
      const mealTime = document.getElementById("meal-time");
      const mealFoodSearch = document.getElementById("meal-food-search");
      const mealFoodSearchBtn = document.getElementById("meal-food-search-btn");
      const mealFoodResults = document.getElementById("meal-food-results");
      const mealStatus = document.getElementById("meal-status");
      const mealList = document.getElementById("meal-list");
      const mealEmpty = document.getElementById("meal-empty");

      // Gyms
      const gymName = document.getElementById("gym-name");
      const gymRating = document.getElementById("gym-rating");
      const gymNote = document.getElementById("gym-note");
      const gymSave = document.getElementById("gym-save");
      const gymClear = document.getElementById("gym-clear");
      const gymStatus = document.getElementById("gym-status");
      const gymSearch = document.getElementById("gym-search");
      const gymList = document.getElementById("gym-list");
      const gymEmpty = document.getElementById("gym-empty");

      // Messages
      const convListEl = document.getElementById("conv-list");
      const chatTitle = document.getElementById("chat-title");
      const chatSub = document.getElementById("chat-sub");
      const chatThread = document.getElementById("chat-thread");
      const chatInput = document.getElementById("chat-input");
      const chatSend = document.getElementById("chat-send");

      // Settings
      const settingsAccountText = document.getElementById("settings-account-text");
      const settingsOpenAuth = document.getElementById("settings-open-auth");
      const peopleSummary = document.getElementById("people-summary");
      const peopleListEl = document.getElementById("people-list");
      const planStatus = document.getElementById("plan-status");
      const btnPlanFree = document.getElementById("btn-plan-free");
      const btnPlanPro = document.getElementById("btn-plan-pro");
      const calTarget = document.getElementById("cal-target");
      const themeSelect = document.getElementById("theme-select");
      const clearAllBtn = document.getElementById("btn-clear-all");
      const clearStatus = document.getElementById("clear-status");

      // Search modal
      const searchBackdrop = document.getElementById("search-backdrop");
      const searchClose = document.getElementById("search-close");
      const searchInput = document.getElementById("search-input");
      const searchResults = document.getElementById("search-results");

      // Profile modal
      const profileBackdrop = document.getElementById("profile-backdrop");
      const profileClose = document.getElementById("profile-close");
      const profileTitle = document.getElementById("profile-title");
      const profileSub = document.getElementById("profile-sub");
      const profileSummary = document.getElementById("profile-summary");
      const profilePosts = document.getElementById("profile-posts");

      // ---- state ----
      let users = [];
      let currentUser = null;
      let posts = [];
      let conversations = [];
      let meals = [];
      let gyms = [];
      let currentConvId = null;

      const DEFAULT_CONVS = [
        { id: "coach", title: "ã‚³ãƒ¼ãƒç›¸è«‡", description: "ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç›¸è«‡ãƒ¡ãƒ¢ç”¨" },
        { id: "community", title: "ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ¡ˆ", description: "ã‚¢ãƒ—ãƒªã‚„ä»²é–“ã¥ãã‚Šã®ã‚¢ã‚¤ãƒ‡ã‚¢" },
        { id: "personal", title: "å€‹äººãƒ¡ãƒ¢", description: "è€ƒãˆäº‹ã‚’æ•´ç†ã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹" },
      ];

      function ensureUserExtraFields(user) {
        if (!user.following) user.following = [];
        if (!user.followers) user.followers = [];
        if (!user.closeFriends) user.closeFriends = [];
        if (!user.bookmarks) user.bookmarks = [];
        if (!user.plan) user.plan = "free";
        if (user.calorieTarget === undefined) user.calorieTarget = null;
        return user;
      }

      // ---- util ----
      function formatDate(dateString) {
        if (!dateString) return "æ—¥ä»˜æœªè¨­å®š";
        const d = new Date(dateString);
        if (Number.isNaN(d.getTime())) return dateString;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}/${m}/${day}`;
      }

      function formatTime(dateString) {
        const d = new Date(dateString);
        if (Number.isNaN(d.getTime())) return "";
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${m}/${day} ${hh}:${mm}`;
      }

      function visibilityLabel(v) {
        switch (v) {
          case "followers": return "ğŸ‘¥ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ã¿";
          case "close": return "â­ è¦ªã—ã„å‹é”";
          case "private": return "ğŸ”’ è‡ªåˆ†ã ã‘";
          default: return "ğŸŒ å…¨å“¡";
        }
      }

      function typeLabel(t) {
        switch (t) {
          case "physique": return "Physique";
          case "note": return "ãƒ¡ãƒ¢";
          default: return "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°";
        }
      }

      function getUserByEmail(email) {
        return users.find(u => u.email === email);
      }

      function canSeePost(viewer, post, owner) {
        const visibility = post.visibility || "public";
        if (!viewer) return visibility === "public";
        if (viewer.email === owner.email) return true;

        switch (visibility) {
          case "public":
            return true;
          case "followers":
            return (owner.followers || []).includes(viewer.handle);
          case "close":
            return (owner.closeFriends || []).includes(viewer.handle);
          case "private":
            return false;
          default:
            return true;
        }
      }

      function readFileAsDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // ---- training set rows ----
      function populateSelectsForRow(repsSelect, setsSelect, rpeSelect) {
        repsSelect.innerHTML = "";
        setsSelect.innerHTML = "";
        rpeSelect.innerHTML = "";

        let opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "reps";
        repsSelect.appendChild(opt);
        for (let i = 1; i <= 20; i++) {
          const o = document.createElement("option");
          o.value = String(i);
          o.textContent = i;
          repsSelect.appendChild(o);
        }

        opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "sets";
        setsSelect.appendChild(opt);
        for (let i = 1; i <= 10; i++) {
          const o = document.createElement("option");
          o.value = String(i);
          o.textContent = i;
          setsSelect.appendChild(o);
        }

        opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "RPE";
        rpeSelect.appendChild(opt);
        for (let x = 5; x <= 10; x += 0.5) {
          const v = x.toFixed(1);
          const o = document.createElement("option");
          o.value = v;
          o.textContent = v;
          rpeSelect.appendChild(o);
        }
      }

      function createTrainingSetRow(initial = {}) {
        const row = document.createElement("div");
        row.className = "training-set-row";

        const exInput = document.createElement("input");
        exInput.type = "text";
        exInput.placeholder = "ç¨®ç›®";
        exInput.value = initial.exercise || "";

        const wInput = document.createElement("input");
        wInput.type = "number";
        wInput.placeholder = "kg";
        wInput.value = initial.weightKg || "";

        const repsSelect = document.createElement("select");
        const setsSelect = document.createElement("select");
        const rpeSelect = document.createElement("select");
        populateSelectsForRow(repsSelect, setsSelect, rpeSelect);

        if (initial.reps) repsSelect.value = String(initial.reps);
        if (initial.sets) setsSelect.value = String(initial.sets);
        if (initial.rpe) rpeSelect.value = String(initial.rpe);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "training-set-remove";
        removeBtn.textContent = "âœ•";
        removeBtn.addEventListener("click", () => {
          trainingSetsContainer.removeChild(row);
          if (!trainingSetsContainer.querySelector(".training-set-row")) {
            createTrainingSetRow();
          }
        });

        row.appendChild(exInput);
        row.appendChild(wInput);
        row.appendChild(repsSelect);
        row.appendChild(setsSelect);
        row.appendChild(rpeSelect);
        row.appendChild(removeBtn);

        trainingSetsContainer.appendChild(row);
      }

      function resetTrainingSets() {
        trainingSetsContainer.innerHTML = "";
        createTrainingSetRow();
      }

      // ---- storage helpers ----
      function loadUsers() {
        try {
          const raw = localStorage.getItem(STORAGE_USERS_KEY);
          users = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(users)) users = [];
        } catch {
          users = [];
        }
        users = users.map(ensureUserExtraFields);
      }
      function saveUsers() {
        localStorage.setItem(STORAGE_USERS_KEY, JSON.stringify(users));
      }

      function loadPosts() {
        try {
          const raw = localStorage.getItem(STORAGE_POSTS_KEY);
          posts = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(posts)) posts = [];
        } catch {
          posts = [];
        }
      }
      function savePosts() {
        localStorage.setItem(STORAGE_POSTS_KEY, JSON.stringify(posts));
      }

      function loadConversations() {
        try {
          const raw = localStorage.getItem(STORAGE_CONVS_KEY);
          conversations = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(conversations)) conversations = [];
        } catch {
          conversations = [];
        }
        DEFAULT_CONVS.forEach(def => {
          if (!conversations.some(c => c.id === def.id)) {
            conversations.push({ id: def.id, title: def.title, description: def.description, messages: [] });
          }
        });
      }
      function saveConversations() {
        localStorage.setItem(STORAGE_CONVS_KEY, JSON.stringify(conversations));
      }

      function loadMeals() {
        try {
          const raw = localStorage.getItem(STORAGE_MEALS_KEY);
          meals = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(meals)) meals = [];
        } catch {
          meals = [];
        }
      }
      function saveMeals() {
        localStorage.setItem(STORAGE_MEALS_KEY, JSON.stringify(meals));
      }

      function loadGyms() {
        try {
          const raw = localStorage.getItem(STORAGE_GYMS_KEY);
          gyms = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(gyms)) gyms = [];
        } catch {
          gyms = [];
        }
      }
      function saveGyms() {
        localStorage.setItem(STORAGE_GYMS_KEY, JSON.stringify(gyms));
      }

      function loadCurrentUser() {
        try {
          const raw = localStorage.getItem(STORAGE_CURRENT_USER_KEY);
          if (!raw) {
            currentUser = null;
            return;
          }
          const obj = JSON.parse(raw);
          if (obj && obj.email) {
            const found = users.find(u => u.email === obj.email);
            currentUser = found ? ensureUserExtraFields(found) : null;
          }
        } catch {
          currentUser = null;
        }
      }
      function saveCurrentUser() {
        if (!currentUser) {
          localStorage.removeItem(STORAGE_CURRENT_USER_KEY);
          return;
        }
        localStorage.setItem(STORAGE_CURRENT_USER_KEY, JSON.stringify({
          email: currentUser.email,
          handle: currentUser.handle,
          createdAt: currentUser.createdAt || new Date().toISOString()
        }));
      }

      function loadTheme() {
        const t = localStorage.getItem(STORAGE_THEME_KEY) || "light";
        applyTheme(t);
        themeSelect.value = t;
      }

      // ---- UI ----
      function updatePlanUI() {
        if (!planStatus) return;
        if (!currentUser) {
          planStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãƒ—ãƒ©ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã™ã€‚";
          calTarget.value = "";
          calTarget.disabled = true;
          return;
        }
        const plan = currentUser.plan || "free";
        planStatus.textContent =
          plan === "pro"
            ? "ç¾åœ¨: Proãƒ—ãƒ©ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰"
            : "ç¾åœ¨: Freeãƒ—ãƒ©ãƒ³";
        calTarget.value = currentUser.calorieTarget || "";
        calTarget.disabled = plan !== "pro";
      }

      function updateNav() {
        if (currentUser) {
          navUserLabel.textContent = `@${currentUser.handle} / ${currentUser.email}` +
            (currentUser.plan === "pro" ? " Â· PRO" : "");
          btnOpenAuth.classList.add("hidden");
          btnLogout.classList.remove("hidden");
          feedStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã€‚ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«æŠ•ç¨¿ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚";
          const followersCount = currentUser.followers?.length || 0;
          const followingCount = currentUser.following?.length || 0;
          settingsAccountText.textContent =
            `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: @${currentUser.handle} / ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ ${followersCount} / ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ ${followingCount}`;
        } else {
          navUserLabel.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ / ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã ã‘ã§ä¿å­˜";
          btnOpenAuth.classList.remove("hidden");
          btnLogout.classList.add("hidden");
          feedStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨æŠ•ç¨¿ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚";
          settingsAccountText.textContent =
            "æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚å³ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
        }
        renderPeopleList();
        updatePlanUI();
      }

      function renderFeed() {
        feedList.innerHTML = "";
        if (!currentUser) {
          feedEmpty.classList.add("hidden");
          return;
        }

        const filter = feedFilter.value || "mine";
        const sorted = [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        const result = [];

        sorted.forEach(post => {
          const owner = getUserByEmail(post.userEmail);
          if (!owner) return;
          ensureUserExtraFields(owner);
          const viewer = currentUser;
          const isBookmarked = viewer && viewer.bookmarks && viewer.bookmarks.includes(post.id);

          if (!canSeePost(viewer, post, owner)) return;

          if (filter === "mine" && post.userEmail !== viewer.email) return;

          if (filter === "following") {
            const isMine = post.userEmail === viewer.email;
            const isFromFollowing = (viewer.following || []).includes(owner.handle);
            if (!isMine && !isFromFollowing) return;
          }

          if (filter === "bookmarks" && !isBookmarked) return;

          result.push({ post, owner, isBookmarked });
        });

        if (result.length === 0) {
          feedEmpty.classList.remove("hidden");
          return;
        }
        feedEmpty.classList.add("hidden");

        result.forEach(({ post, owner, isBookmarked }) => {
          const card = document.createElement("article");
          card.className = "post-card";

          const header = document.createElement("div");
          header.className = "post-header";

          const left = document.createElement("div");
          left.className = "post-meta-left";

          const avatar = document.createElement("div");
          avatar.className = "avatar";
          avatar.textContent = (owner.handle || "?").charAt(0).toUpperCase();

          const metaTexts = document.createElement("div");
          metaTexts.className = "post-meta-texts";

          const nameRow = document.createElement("div");
          nameRow.className = "post-name";
          const nameSpan = document.createElement("span");
          nameSpan.textContent = owner.handle || "user";
          const handleSpan = document.createElement("span");
          handleSpan.className = "post-handle";
          handleSpan.textContent = `@${owner.handle || "user"}`;
          nameRow.appendChild(nameSpan);
          nameRow.appendChild(handleSpan);

          const subRow = document.createElement("div");
          subRow.className = "post-sub";
          subRow.textContent = `${formatDate(post.date)} Â· ${formatTime(post.createdAt)}`;

          metaTexts.appendChild(nameRow);
          metaTexts.appendChild(subRow);

          left.appendChild(avatar);
          left.appendChild(metaTexts);

          const right = document.createElement("div");
          right.className = "pill-row";

          const typeBadge = document.createElement("div");
          typeBadge.className = "badge type";
          typeBadge.textContent = typeLabel(post.type || "training");
          right.appendChild(typeBadge);

          const visBadge = document.createElement("div");
          visBadge.className = "badge";
          visBadge.textContent = visibilityLabel(post.visibility || "public");
          right.appendChild(visBadge);

          if (currentUser && currentUser.email === owner.email) {
            const delBtn = document.createElement("button");
            delBtn.className = "btn small";
            delBtn.textContent = "å‰Šé™¤";
            delBtn.addEventListener("click", () => {
              if (!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
              posts = posts.filter(p => p.id !== post.id);
              savePosts();
              renderFeed();
            });
            right.appendChild(delBtn);
          }

          header.appendChild(left);
          header.appendChild(right);

          const body = document.createElement("div");
          body.className = "post-body";
          const strong = document.createElement("strong");
          strong.textContent =
            post.type === "note" ? "ãƒ¡ãƒ¢" :
            (post.type === "physique" ? "Physique" :
            (post.exercise || "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°"));
          body.appendChild(strong);
          body.appendChild(document.createTextNode(post.note || ""));

          card.appendChild(header);
          card.appendChild(body);

          const trainingDiv = document.createElement("div");
          trainingDiv.className = "post-training";
          const lines = [];

          if (Array.isArray(post.trainingSets) && post.trainingSets.length > 0) {
            post.trainingSets.forEach(set => {
              if (!set) return;
              const parts = [];
              if (set.exercise) parts.push(set.exercise);
              if (set.weightKg) parts.push(`${set.weightKg}kg`);
              if (set.reps) parts.push(`${set.reps}reps`);
              if (set.sets) parts.push(`${set.sets}sets`);
              if (set.rpe) parts.push(`RPE${set.rpe}`);
              if (parts.length > 0) lines.push(parts.join(" Ã— "));
            });
          }

          if (post.bodyWeight) {
            lines.push(`ä½“é‡ ${post.bodyWeight}kg`);
          }

          if (lines.length > 0 && post.type === "training") {
            lines.forEach(text => {
              const l = document.createElement("div");
              l.textContent = text;
              trainingDiv.appendChild(l);
            });
            card.appendChild(trainingDiv);
          }

          if (post.mediaType && (post.mediaData || post.mediaUrl || post.mediaSessionUrl)) {
            const media = document.createElement("div");
            media.className = "post-media";
            const inner = document.createElement("div");
            inner.className = "post-media-inner";

            const src = post.mediaData || post.mediaUrl || post.mediaSessionUrl;
            if (post.mediaType === "video") {
              const v = document.createElement("video");
              v.src = src;
              v.controls = true;
              inner.appendChild(v);
            } else {
              const img = document.createElement("img");
              img.src = src;
              img.alt = "media";
              img.onerror = () => {
                inner.innerHTML = "";
                const ph = document.createElement("div");
                ph.className = "post-media-placeholder";
                ph.textContent = "ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚";
                inner.appendChild(ph);
              };
              inner.appendChild(img);
            }
            media.appendChild(inner);
            card.appendChild(media);
          }

          const footer = document.createElement("div");
          footer.className = "post-footer";

          const actions = document.createElement("div");
          actions.className = "post-actions";

          // like
          const likeBtn = document.createElement("button");
          likeBtn.className = "icon-btn";
          likeBtn.type = "button";
          const liked = post.liked === true;
          likeBtn.textContent = liked ? "ğŸ’™" : "ğŸ¤";
          likeBtn.title = "ã„ã„ã­";
          likeBtn.addEventListener("click", () => {
            if (typeof post.likes !== "number") post.likes = 0;
            if (post.liked) {
              post.liked = false;
              post.likes = Math.max(post.likes - 1, 0);
            } else {
              post.liked = true;
              post.likes += 1;
            }
            savePosts();
            renderFeed();
          });
          actions.appendChild(likeBtn);

          // bookmark
          const bmBtn = document.createElement("button");
          bmBtn.className = "icon-btn";
          bmBtn.type = "button";
          bmBtn.textContent = isBookmarked ? "ğŸ”–" : "ğŸ“‘";
          bmBtn.title = "ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯";
          bmBtn.addEventListener("click", () => {
            if (!currentUser) {
              openAuthModal();
              return;
            }
            ensureUserExtraFields(currentUser);
            currentUser.bookmarks = currentUser.bookmarks || [];
            const idx = currentUser.bookmarks.indexOf(post.id);
            if (idx >= 0) {
              currentUser.bookmarks.splice(idx, 1);
            } else {
              currentUser.bookmarks.push(post.id);
            }
            users = users.map(u => (u.email === currentUser.email ? currentUser : u));
            saveUsers();
            saveCurrentUser();
            renderFeed();
          });
          actions.appendChild(bmBtn);

          const likesText = document.createElement("div");
          likesText.className = "likes-text";
          const likeCount = typeof post.likes === "number" ? post.likes : 0;
          const commentsCount = Array.isArray(post.comments) ? post.comments.length : 0;
          likesText.textContent = `ã„ã„ã­ ${likeCount}ä»¶ / ã‚³ãƒ¡ãƒ³ãƒˆ ${commentsCount}ä»¶`;

          footer.appendChild(actions);
          footer.appendChild(likesText);

          card.appendChild(footer);

          // comments
          const commentsSection = document.createElement("div");
          commentsSection.className = "comments-section";

          const commentsList = document.createElement("div");
          commentsList.className = "comments-list";

          const comments = Array.isArray(post.comments) ? post.comments : [];
          if (comments.length === 0) {
            const empty = document.createElement("div");
            empty.className = "comment-meta";
            empty.textContent = "ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
            commentsList.appendChild(empty);
          } else {
            comments.forEach(c => {
              const item = document.createElement("div");
              item.className = "comment-item";
              const meta = document.createElement("div");
              meta.className = "comment-meta";
              meta.textContent = `@${c.handle || "user"} Â· ${formatTime(c.createdAt)}`;
              const text = document.createElement("div");
              text.textContent = c.text;
              item.appendChild(meta);
              item.appendChild(text);
              commentsList.appendChild(item);
            });
          }

          const commentForm = document.createElement("div");
          commentForm.className = "comment-form";
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = currentUser ? "ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãâ€¦" : "ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„";
          const btn = document.createElement("button");
          btn.className = "btn small";
          btn.type = "button";
          btn.textContent = "é€ä¿¡";

          btn.addEventListener("click", () => {
            if (!currentUser) {
              openAuthModal();
              return;
            }
            const text = input.value.trim();
            if (!text) return;
            const list = Array.isArray(post.comments) ? post.comments : [];
            const newComment = {
              id: "c_" + Date.now() + "_" + Math.random().toString(36).slice(2),
              userEmail: currentUser.email,
              handle: currentUser.handle,
              text,
              createdAt: new Date().toISOString()
            };
            list.push(newComment);
            post.comments = list;
            savePosts();
            renderFeed();
          });

          commentForm.appendChild(input);
          commentForm.appendChild(btn);

          commentsSection.appendChild(commentsList);
          commentsSection.appendChild(commentForm);

          card.appendChild(commentsSection);

          feedList.appendChild(card);
        });
      }

      function renderConvList() {
        convListEl.innerHTML = "";
        conversations.forEach(conv => {
          const pill = document.createElement("div");
          pill.className = "conv-pill" + (conv.id === currentConvId ? " active" : "");
          pill.textContent = conv.title;
          pill.addEventListener("click", () => {
            currentConvId = conv.id;
            renderConvList();
            renderChat();
          });
          convListEl.appendChild(pill);
        });

        const add = document.createElement("div");
        add.className = "conv-pill";
        add.textContent = "ï¼‹ æ–°è¦";
        add.addEventListener("click", () => {
          const title = prompt("æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰å");
          if (!title) return;
          const id = "conv_" + Date.now();
          conversations.push({ id, title, description: "", messages: [] });
          saveConversations();
          currentConvId = id;
          renderConvList();
          renderChat();
        });
        convListEl.appendChild(add);
      }

      function renderChat() {
        chatThread.innerHTML = "";
        const conv = conversations.find(c => c.id === currentConvId);
        if (!conv) {
          chatTitle.textContent = "ä¼šè©±ã‚’é¸æŠã—ã¦ãã ã•ã„";
          chatSub.textContent = "ä¸Šã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰é¸ã¶ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
          return;
        }
        chatTitle.textContent = conv.title;
        chatSub.textContent = conv.description || "";

        if (!conv.messages || conv.messages.length === 0) {
          const info = document.createElement("div");
          info.className = "empty";
          info.textContent = "ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          chatThread.appendChild(info);
          return;
        }

        conv.messages
          .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
          .forEach(msg => {
            const div = document.createElement("div");
            div.className = "msg " + (msg.from === "me" ? "me" : "other");

            const text = document.createElement("div");
            text.textContent = msg.text;

            const meta = document.createElement("div");
            meta.className = "msg-meta";
            meta.textContent = `${msg.from === "me" ? "è‡ªåˆ†" : msg.fromHandle || ""} Â· ${formatTime(msg.createdAt)}`;

            div.appendChild(text);
            div.appendChild(meta);
            chatThread.appendChild(div);
          });

        chatThread.scrollTop = chatThread.scrollHeight;
      }

      function renderPeopleList() {
        peopleListEl.innerHTML = "";
        if (!users || users.length === 0) {
          peopleSummary.textContent = "ã¾ã ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
          return;
        }
        if (!currentUser) {
          peopleSummary.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãƒ•ã‚©ãƒ­ãƒ¼è¨­å®šãŒã§ãã¾ã™ã€‚";
          return;
        }

        const followersCount = currentUser.followers?.length || 0;
        const followingCount = currentUser.following?.length || 0;
        const closeCount = currentUser.closeFriends?.length || 0;
        peopleSummary.textContent =
          `@${currentUser.handle} / ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ ${followersCount} / ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ ${followingCount} / è¦ªã—ã„å‹é” ${closeCount}`;

        const others = users.filter(u => u.email !== currentUser.email);
        if (others.length === 0) {
          const info = document.createElement("div");
          info.className = "status";
          info.textContent = "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã¾ã ã„ã¾ã›ã‚“ã€‚";
          peopleListEl.appendChild(info);
          return;
        }

        others.forEach(u => {
          ensureUserExtraFields(u);
          const item = document.createElement("div");
          item.className = "people-item";

          const row = document.createElement("div");
          row.className = "people-row";

          const main = document.createElement("div");
          main.className = "people-main";

          const h = document.createElement("div");
          h.textContent = `@${u.handle || "user"}`;

          const sub = document.createElement("div");
          sub.className = "people-sub";
          const fCount = u.followers?.length || 0;
          const gCount = u.following?.length || 0;
          sub.textContent = `ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ ${fCount} / ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ ${gCount}`;

          main.appendChild(h);
          main.appendChild(sub);

          const btnBox = document.createElement("div");
          btnBox.style.display = "flex";
          btnBox.style.flexDirection = "column";
          btnBox.style.gap = "4px";

          const isFollowing = (currentUser.following || []).includes(u.handle);
          const followBtn = document.createElement("button");
          followBtn.className = "btn small";
          followBtn.textContent = isFollowing ? "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­" : "ãƒ•ã‚©ãƒ­ãƒ¼";
          followBtn.addEventListener("click", () => toggleFollow(currentUser, u));

          const isClose = (currentUser.closeFriends || []).includes(u.handle);
          const closeBtn = document.createElement("button");
          closeBtn.className = "btn small";
          closeBtn.textContent = isClose ? "â­ è¦ªã—ã„å‹é”" : "â˜† è¦ªã—ã„å‹é”ã«";
          closeBtn.addEventListener("click", () => toggleCloseFriend(currentUser, u));

          btnBox.appendChild(followBtn);
          btnBox.appendChild(closeBtn);

          row.appendChild(main);
          row.appendChild(btnBox);

          const pill = document.createElement("div");
          pill.className = "pill-follow";
          const rel = [];
          if (isFollowing) rel.push("ã‚ãªãŸãŒãƒ•ã‚©ãƒ­ãƒ¼ä¸­");
          if ((u.followers || []).includes(currentUser.handle)) rel.push("ã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼");
          if (isClose) rel.push("è¦ªã—ã„å‹é”");
          pill.textContent = rel.length ? rel.join(" / ") : "é–¢ä¿‚ãªã—";

          item.appendChild(row);
          item.appendChild(pill);

          peopleListEl.appendChild(item);
        });
      }

      function toggleFollow(me, other) {
        ensureUserExtraFields(me);
        ensureUserExtraFields(other);

        const isFollowing = (me.following || []).includes(other.handle);
        if (isFollowing) {
          me.following = me.following.filter(h => h !== other.handle);
          other.followers = (other.followers || []).filter(h => h !== me.handle);
        } else {
          me.following.push(other.handle);
          other.followers = other.followers || [];
          if (!other.followers.includes(me.handle)) {
            other.followers.push(me.handle);
          }
        }
        users = users.map(u => {
          if (u.email === me.email) return me;
          if (u.email === other.email) return other;
          return u;
        });
        saveUsers();
        updateNav();
        renderFeed();
      }

      function toggleCloseFriend(me, other) {
        ensureUserExtraFields(me);
        me.closeFriends = me.closeFriends || [];
        const isClose = me.closeFriends.includes(other.handle);
        if (isClose) {
          me.closeFriends = me.closeFriends.filter(h => h !== other.handle);
        } else {
          me.closeFriends.push(other.handle);
        }
        users = users.map(u => (u.email === me.email ? me : u));
        saveUsers();
        updateNav();
      }

      // ---- Meals ----
      function addMealFromFood(food, multiplier) {
        if (!currentUser) {
          mealStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰é£Ÿäº‹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚";
          return;
        }
        const dateVal = mealDate.value;
        const timeVal = mealTime.value;
        if (!dateVal) {
          mealStatus.textContent = "æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
          return;
        }
        const factor = Number(multiplier) > 0 ? Number(multiplier) : 1;
        const meal = {
          id: "meal_" + Date.now() + "_" + Math.random().toString(36).slice(2),
          userEmail: currentUser.email,
          date: dateVal,
          time: timeVal,
          title: `${food.name} x${factor}`,
          note: `${Math.round(food.kcal * factor)}kcal / P${Math.round(food.protein * factor)}g / F${Math.round(food.fat * factor)}g / C${Math.round(food.carbs * factor)}g`,
          kcal: Math.round(food.kcal * factor),
          protein: Math.round(food.protein * factor),
          fat: Math.round(food.fat * factor),
          carbs: Math.round(food.carbs * factor),
          createdAt: new Date().toISOString()
        };
        meals.push(meal);
        saveMeals();
        mealStatus.textContent = "é£Ÿäº‹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚";
        renderMeals();
      }

      function renderMeals() {
        mealList.innerHTML = "";
        if (!currentUser) {
          mealEmpty.classList.add("hidden");
          return;
        }
        const selectedDate = mealDate.value;
        let myMeals = meals.filter(m => m.userEmail === currentUser.email);
        if (selectedDate) {
          myMeals = myMeals.filter(m => m.date === selectedDate);
        }
        if (myMeals.length === 0) {
          mealEmpty.classList.remove("hidden");
          return;
        }
        mealEmpty.classList.add("hidden");

        let totalKcal = 0, totalP = 0, totalF = 0, totalC = 0;
        myMeals.forEach(m => {
          totalKcal += m.kcal || 0;
          totalP += m.protein || 0;
          totalF += m.fat || 0;
          totalC += m.carbs || 0;
        });

        const summary = document.createElement("div");
        summary.className = "meal-summary";

        const main = document.createElement("div");
        main.className = "meal-summary-main";
        main.textContent = `${selectedDate ? formatDate(selectedDate) : "å…¨æœŸé–“"} ã®åˆè¨ˆ: ${totalKcal}kcal`;

        const sub = document.createElement("div");
        sub.className = "meal-summary-sub";
        const pText = `P${totalP}g`;
        const fText = `F${totalF}g`;
        const cText = `C${totalC}g`;

        if (currentUser && currentUser.calorieTarget && currentUser.calorieTarget > 0) {
          const target = currentUser.calorieTarget;
          const ratio = Math.min(totalKcal / target, 1);
          sub.textContent = `${pText} / ${fText} / ${cText} Â· ç›®æ¨™ ${target}kcal ã® ${(ratio * 100).toFixed(0)}%`;
          const bar = document.createElement("div");
          bar.className = "meal-summary-bar";
          const inner = document.createElement("div");
          inner.className = "meal-summary-bar-inner";
          inner.style.width = `${Math.min(ratio * 100, 100)}%`;
          bar.appendChild(inner);
          summary.appendChild(main);
          summary.appendChild(sub);
          summary.appendChild(bar);
        } else {
          sub.textContent = `${pText} / ${fText} / ${cText}`;
          summary.appendChild(main);
          summary.appendChild(sub);
        }

        mealList.appendChild(summary);

        const sorted = [...myMeals].sort((a, b) =>
          (b.date + "T23:59:59").localeCompare(a.date + "T23:59:59") ||
          new Date(b.createdAt) - new Date(a.createdAt)
        );

        sorted.forEach(m => {
          const item = document.createElement("div");
          item.className = "meal-item";

          const top = document.createElement("div");
          top.className = "meal-top";

          const left = document.createElement("div");
          left.textContent = `${m.time || ""} Â· ${m.title || ""}`;

          const right = document.createElement("div");
          right.className = "tag-pill";
          right.textContent = `${m.kcal || "?"}kcal`;

          top.appendChild(left);
          top.appendChild(right);

          const mainLine = document.createElement("div");
          mainLine.className = "meal-main";
          mainLine.textContent = m.note || "";

          const meta = document.createElement("div");
          meta.className = "meal-meta";
          meta.textContent = `ç™»éŒ²: ${formatTime(m.createdAt)}`;

          const delBtn = document.createElement("button");
          delBtn.className = "btn small";
          delBtn.style.alignSelf = "flex-end";
          delBtn.textContent = "å‰Šé™¤";
          delBtn.addEventListener("click", () => {
            if (!confirm("ã“ã®é£Ÿäº‹ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            meals = meals.filter(x => x.id !== m.id);
            saveMeals();
            renderMeals();
          });

          item.appendChild(top);
          item.appendChild(mainLine);
          item.appendChild(meta);
          item.appendChild(delBtn);

          mealList.appendChild(item);
        });
      }

      function searchFood() {
        mealFoodResults.innerHTML = "";
        const q = (mealFoodSearch.value || "").trim().toLowerCase();
        if (!q) {
          mealFoodResults.innerHTML = "";
          return;
        }
        const results = FOOD_DB.filter(f => f.name.toLowerCase().includes(q));
        if (results.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "è©²å½“ã™ã‚‹é£Ÿã¹ç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
          mealFoodResults.appendChild(empty);
          return;
        }

        results.forEach(food => {
          const card = document.createElement("div");
          card.className = "food-result";

          const top = document.createElement("div");
          top.className = "food-result-top";

          const nameSpan = document.createElement("div");
          nameSpan.textContent = food.name;

          const kcalSpan = document.createElement("div");
          kcalSpan.className = "tag-pill";
          kcalSpan.textContent = `${food.kcal}kcal`;

          top.appendChild(nameSpan);
          top.appendChild(kcalSpan);

          const macro = document.createElement("div");
          macro.className = "food-macro";
          macro.textContent =
            `P${food.protein}g / F${food.fat}g / C${food.carbs}gï¼ˆ1é£Ÿåˆ†ç›®å®‰ï¼‰`;

          const qtyRow = document.createElement("div");
          qtyRow.style.display = "flex";
          qtyRow.style.alignItems = "center";
          qtyRow.style.gap = "4px";
          qtyRow.style.marginTop = "4px";

          const qtyLabel = document.createElement("span");
          qtyLabel.className = "food-macro";
          qtyLabel.textContent = "ä½•é£Ÿåˆ†:";

          const qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.min = "0.25";
          qtyInput.step = "0.25";
          qtyInput.value = "1";
          qtyInput.style.width = "60px";
          qtyInput.style.fontSize = "11px";
          qtyInput.style.padding = "4px 6px";

          const btnRow = document.createElement("div");
          btnRow.className = "btn-row";
          const addBtn = document.createElement("button");
          addBtn.className = "btn small";
          addBtn.textContent = "ã“ã®é‡ã§è¿½åŠ ";
          addBtn.addEventListener("click", () => {
            const factor = Number(qtyInput.value) || 1;
            addMealFromFood(food, factor);
          });
          btnRow.appendChild(addBtn);

          qtyRow.appendChild(qtyLabel);
          qtyRow.appendChild(qtyInput);

          card.appendChild(top);
          card.appendChild(macro);
          card.appendChild(qtyRow);
          card.appendChild(btnRow);

          mealFoodResults.appendChild(card);
        });
      }

      // ---- Gyms ----
      function stars(n) {
        if (!n || n < 1) return "è©•ä¾¡ãªã—";
        const full = "â˜…".repeat(n);
        const empty = "â˜†".repeat(5 - n);
        return full + empty;
      }

      function renderGyms() {
        gymList.innerHTML = "";
        if (!currentUser) {
          gymEmpty.classList.add("hidden");
          return;
        }
        const query = (gymSearch.value || "").toLowerCase();
        let myGyms = gyms.filter(g => g.userEmail === currentUser.email);
        if (query) {
          myGyms = myGyms.filter(g => g.name.toLowerCase().includes(query));
        }
        if (myGyms.length === 0) {
          gymEmpty.classList.remove("hidden");
          return;
        }
        gymEmpty.classList.add("hidden");

        myGyms
          .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
          .forEach(g => {
            const item = document.createElement("div");
            item.className = "gym-item";

            const top = document.createElement("div");
            top.className = "gym-top";
            const left = document.createElement("div");
            left.textContent = g.name;
            const right = document.createElement("div");
            right.className = "rating-stars";
            right.textContent = g.rating ? stars(g.rating) : "è©•ä¾¡ãªã—";
            top.appendChild(left);
            top.appendChild(right);

            const main = document.createElement("div");
            main.className = "gym-main";
            main.textContent = g.note || "(ãƒ¡ãƒ¢ãªã—)";

            const meta = document.createElement("div");
            meta.className = "gym-meta";
            meta.textContent = `æ›´æ–°: ${formatTime(g.updatedAt)}`;

            const delBtn = document.createElement("button");
            delBtn.className = "btn small";
            delBtn.style.alignSelf = "flex-end";
            delBtn.textContent = "å‰Šé™¤";
            delBtn.addEventListener("click", () => {
              if (!confirm("ã“ã®ã‚¸ãƒ æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
              gyms = gyms.filter(x => x.id !== g.id);
              saveGyms();
              renderGyms();
            });

            item.appendChild(top);
            item.appendChild(main);
            item.appendChild(meta);
            item.appendChild(delBtn);

            gymList.appendChild(item);
          });
      }

      function clearGymForm() {
        gymName.value = "";
        gymRating.value = "";
        gymNote.value = "";
      }

      // ---- Auth modal ----
      function openAuthModal() {
        authStatus.textContent = "";
        authBackdrop.classList.remove("hidden");
      }
      function closeAuthModal() {
        authBackdrop.classList.add("hidden");
      }

      btnOpenAuth.addEventListener("click", openAuthModal);
      settingsOpenAuth.addEventListener("click", openAuthModal);
      authClose.addEventListener("click", closeAuthModal);
      authBackdrop.addEventListener("click", (e) => {
        if (e.target === authBackdrop) closeAuthModal();
      });

      authFillDemo.addEventListener("click", () => {
        authEmail.value = "demo@example.com";
        authHandle.value = "demo_lifter";
        authPassword.value = "password123";
        authStatus.textContent = "ãƒ†ã‚¹ãƒˆç”¨æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã—ãŸã€‚";
      });

      authForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const email = authEmail.value.trim();
        const handle = authHandle.value.trim();
        const pw = authPassword.value;

        if (!email || !pw) {
          authStatus.textContent = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™ã€‚";
          return;
        }

        const idx = users.findIndex(u => u.email === email);
        if (idx >= 0) {
          const existing = ensureUserExtraFields(users[idx]);
          if (existing.password !== pw) {
            authStatus.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
            return;
          }
          currentUser = existing;
          saveCurrentUser();
          authStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚";
        } else {
          const user = ensureUserExtraFields({
            email,
            handle: handle || email.split("@")[0],
            password: pw,
            createdAt: new Date().toISOString()
          });
          users.push(user);
          saveUsers();
          currentUser = user;
          saveCurrentUser();
          authStatus.textContent = "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚";
        }

        updateNav();
        renderFeed();
        renderPeopleList();
        renderMeals();
        renderGyms();
        closeAuthModal();
      });

      // ---- logout ----
      btnLogout.addEventListener("click", () => {
        if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ï¼‰")) return;
        currentUser = null;
        saveCurrentUser();
        updateNav();
        renderFeed();
        renderMeals();
        renderGyms();
      });

      // ---- Post modal ----
      function openPostModal() {
        if (!currentUser) {
          openAuthModal();
          authStatus.textContent = "å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
          return;
        }
        postStatus.textContent = "";
        postBackdrop.classList.remove("hidden");
      }
      function closePostModal() {
        postBackdrop.classList.add("hidden");
      }

      fabPost.addEventListener("click", openPostModal);
      postClose.addEventListener("click", closePostModal);
      postBackdrop.addEventListener("click", (e) => {
        if (e.target === postBackdrop) closePostModal();
      });

      function clearPostForm() {
        const today = new Date().toISOString().slice(0, 10);
        postDate.value = today;
        postBodyweight.value = "";
        postVisibility.value = "public";
        if (postMediaFile) postMediaFile.value = "";
        postNote.value = "";
        resetTrainingSets();
      }

      postClear.addEventListener("click", () => {
        clearPostForm();
        postStatus.textContent = "å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚";
      });

      btnAddSet.addEventListener("click", () => createTrainingSetRow());

      postForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUser) {
          postStatus.textContent = "å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
          return;
        }

        const dateVal = postDate.value;
        const bw = postBodyweight.value.trim();
        const visibility = postVisibility.value || "public";
        const note = postNote.value.trim();

        let mediaType = "";
        let mediaUrl = "";
        let mediaData = "";

        if (postMediaFile && postMediaFile.files && postMediaFile.files[0]) {
          const file = postMediaFile.files[0];
          mediaType = file.type.startsWith("video") ? "video" : "image";
          try {
            mediaData = await readFileAsDataUrl(file);
          } catch (err) {
            console.error(err);
            postStatus.textContent = "ç”»åƒ/å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            return;
          }
        }

        const trainingSets = [];
        const rows = trainingSetsContainer.querySelectorAll(".training-set-row");
        rows.forEach(row => {
          const inputs = row.querySelectorAll("input,select");
          if (inputs.length < 5) return;
          const exercise = inputs[0].value.trim();
          const weightKg = inputs[1].value.trim();
          const reps = inputs[2].value;
          const sets = inputs[3].value;
          const rpe = inputs[4].value;
          if (exercise || weightKg || reps || sets || rpe) {
            trainingSets.push({ exercise, weightKg, reps, sets, rpe });
          }
        });

        const hasTraining = trainingSets.length > 0;
        const hasMedia = !!mediaData || !!mediaUrl;
        const hasNote = !!note;

        if (!dateVal) {
          postStatus.textContent = "æ—¥ä»˜ã¯å¿…é ˆã§ã™ã€‚";
          return;
        }
        if (!hasTraining && !hasMedia && !hasNote) {
          postStatus.textContent = "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° / ãƒ¡ãƒ¢ / ç”»åƒã®ã©ã‚Œã‹ã¯å…¥ã‚Œã¦ãã ã•ã„ã€‚";
          return;
        }

        let postType = "note";
        if (hasTraining) postType = "training";
        else if (hasMedia) postType = "physique";

        const firstSet = trainingSets[0] || {};

        const post = {
          id: "post_" + Date.now() + "_" + Math.random().toString(36).slice(2),
          userEmail: currentUser.email,
          userHandle: currentUser.handle,
          type: postType,
          date: dateVal,
          bodyWeight: bw || null,
          visibility,
          note,
          trainingSets,
          exercise: firstSet.exercise || "",
          weightKg: firstSet.weightKg || "",
          reps: firstSet.reps || "",
          sets: firstSet.sets || "",
          rpe: firstSet.rpe || "",
          mediaType,
          mediaUrl,
          mediaData,
          mediaSessionUrl: "",
          likes: 0,
          liked: false,
          comments: [],
          createdAt: new Date().toISOString()
        };

        posts.push(post);
        savePosts();
        postStatus.textContent = "æŠ•ç¨¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚";
        clearPostForm();
        closePostModal();
        renderFeed();
      });

      // ---- Messages ----
      chatSend.addEventListener("click", () => {
        if (!currentConvId) {
          alert("å…ˆã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
          return;
        }
        const text = chatInput.value.trim();
        if (!text) return;
        const conv = conversations.find(c => c.id === currentConvId);
        if (!conv) return;
        conv.messages = conv.messages || [];
        conv.messages.push({
          id: "msg_" + Date.now() + "_" + Math.random().toString(36).slice(2),
          from: "me",
          fromHandle: currentUser ? currentUser.handle : "me",
          text,
          createdAt: new Date().toISOString()
        });
        saveConversations();
        chatInput.value = "";
        renderChat();
      });

      // ---- side tabs ----
      sideTabBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const section = btn.dataset.section;
          sideTabBtns.forEach(b => b.classList.toggle("active", b === btn));
          sideSections.forEach(s => s.classList.toggle("active", s.id === "side-" + section));
        });
      });

      // ---- events: Meals / Gyms / theme / plan ----
      mealFoodSearchBtn.addEventListener("click", searchFood);
      mealFoodSearch.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          searchFood();
        }
      });

      mealDate.addEventListener("change", renderMeals);

      gymSave.addEventListener("click", () => {
        if (!currentUser) {
          gymStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ã‚¸ãƒ æƒ…å ±ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚";
          return;
        }
        const nameVal = gymName.value.trim();
        const ratingVal = gymRating.value;
        const noteVal = gymNote.value.trim();
        if (!nameVal) {
          gymStatus.textContent = "ã‚¸ãƒ åã¯å¿…é ˆã§ã™ã€‚";
          return;
        }
        if (!ratingVal && !noteVal) {
          gymStatus.textContent = "è©•ä¾¡ã‹ãƒ¡ãƒ¢ã®ã©ã¡ã‚‰ã‹ã¯å…¥ã‚Œã¦ãã ã•ã„ã€‚";
          return;
        }
        const gym = {
          id: "gym_" + Date.now() + "_" + Math.random().toString(36).slice(2),
          userEmail: currentUser.email,
          name: nameVal,
          rating: ratingVal ? Number(ratingVal) : null,
          note: noteVal,
          updatedAt: new Date().toISOString()
        };
        const idx = gyms.findIndex(g => g.userEmail === currentUser.email && g.name === nameVal);
        if (idx >= 0) {
          gyms[idx] = gym;
        } else {
          gyms.push(gym);
        }
        saveGyms();
        gymStatus.textContent = "ã‚¸ãƒ æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚";
        clearGymForm();
        renderGyms();
      });

      gymClear.addEventListener("click", () => {
        clearGymForm();
        gymStatus.textContent = "å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚";
      });

      gymSearch.addEventListener("input", renderGyms);

      themeSelect.addEventListener("change", () => {
        const value = themeSelect.value || "light";
        applyTheme(value);
      });

      btnPlanFree.addEventListener("click", () => {
        if (!currentUser) {
          openAuthModal();
          return;
        }
        currentUser.plan = "free";
        users = users.map(u => (u.email === currentUser.email ? currentUser : u));
        saveUsers();
        saveCurrentUser();
        updateNav();
        renderMeals();
      });

      btnPlanPro.addEventListener("click", () => {
        if (!currentUser) {
          openAuthModal();
          return;
        }
        alert("Proãƒ—ãƒ©ãƒ³ã¯ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã™ã€‚å®Ÿéš›ã®èª²é‡‘ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
        currentUser.plan = "pro";
        users = users.map(u => (u.email === currentUser.email ? currentUser : u));
        saveUsers();
        saveCurrentUser();
        updateNav();
        renderMeals();
      });

      calTarget.addEventListener("change", () => {
        if (!currentUser) {
          calTarget.value = "";
          return;
        }
        if (currentUser.plan !== "pro") {
          calTarget.value = currentUser.calorieTarget || "";
          alert("ã‚«ãƒ­ãƒªãƒ¼ç›®æ¨™ã®ç·¨é›†ã¯ Proãƒ—ãƒ©ãƒ³å°‚ç”¨ã§ã™ã€‚");
          return;
        }
        const v = parseInt(calTarget.value, 10);
        currentUser.calorieTarget = Number.isFinite(v) && v > 0 ? v : null;
        users = users.map(u => (u.email === currentUser.email ? currentUser : u));
        saveUsers();
        saveCurrentUser();
        renderMeals();
      });

      clearAllBtn.addEventListener("click", () => {
        if (!confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        localStorage.removeItem(STORAGE_USERS_KEY);
        localStorage.removeItem(STORAGE_CURRENT_USER_KEY);
        localStorage.removeItem(STORAGE_POSTS_KEY);
        localStorage.removeItem(STORAGE_CONVS_KEY);
        localStorage.removeItem(STORAGE_MEALS_KEY);
        localStorage.removeItem(STORAGE_GYMS_KEY);
        users = [];
        posts = [];
        conversations = [];
        meals = [];
        gyms = [];
        currentUser = null;
        currentConvId = null;
        loadConversations();
        updateNav();
        renderFeed();
        renderConvList();
        renderChat();
        renderPeopleList();
        renderMeals();
        renderGyms();
        clearStatus.textContent = "å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚";
      });

      // ---- Profile ----
      function openProfile(handle) {
        const user = users.find(u => (u.handle || "").toLowerCase() === (handle || "").toLowerCase());
        if (!user) {
          alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }

        profileTitle.textContent = `@${user.handle || "user"}`;
        const followersCount = user.followers?.length || 0;
        const followingCount = user.following?.length || 0;
        const closeCount = user.closeFriends?.length || 0;

        profileSub.textContent =
          `${user.email || ""} / ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ ${followersCount} / ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ ${followingCount} / è¦ªã—ã„å‹é” ${closeCount}`;

        profileSummary.innerHTML = "";
        if (currentUser) {
          const card = document.createElement("div");
          card.className = "people-item";

          const row = document.createElement("div");
          row.className = "people-row";

          const main = document.createElement("div");
          main.className = "people-main";

          const selfRel = document.createElement("div");
          selfRel.className = "people-sub";

          const rel = [];
          if ((currentUser.following || []).includes(user.handle)) rel.push("ã‚ãªãŸãŒãƒ•ã‚©ãƒ­ãƒ¼ä¸­");
          if ((user.followers || []).includes(currentUser.handle)) rel.push("ã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼");
          if ((currentUser.closeFriends || []).includes(user.handle)) rel.push("è¦ªã—ã„å‹é”ã«è¨­å®šä¸­");

          selfRel.textContent = rel.length ? rel.join(" / ") : "ç¾åœ¨é–¢ä¿‚ãªã—";

          main.appendChild(selfRel);

          const btnBox = document.createElement("div");
          btnBox.style.display = "flex";
          btnBox.style.flexDirection = "column";
          btnBox.style.gap = "4px";

          const isFollowing = (currentUser.following || []).includes(user.handle);
          const followBtn = document.createElement("button");
          followBtn.className = "btn small";
          followBtn.textContent = isFollowing ? "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­" : "ãƒ•ã‚©ãƒ­ãƒ¼";
          followBtn.addEventListener("click", () => toggleFollow(currentUser, user));

          const isClose = (currentUser.closeFriends || []).includes(user.handle);
          const closeBtn = document.createElement("button");
          closeBtn.className = "btn small";
          closeBtn.textContent = isClose ? "â­ è¦ªã—ã„å‹é”" : "â˜† è¦ªã—ã„å‹é”ã«";
          closeBtn.addEventListener("click", () => toggleCloseFriend(currentUser, user));

          btnBox.appendChild(followBtn);
          btnBox.appendChild(closeBtn);

          row.appendChild(main);
          row.appendChild(btnBox);
          card.appendChild(row);
          profileSummary.appendChild(card);
        } else {
          const info = document.createElement("div");
          info.className = "status";
          info.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚";
          profileSummary.appendChild(info);
        }

        profilePosts.innerHTML = "";
        const userPosts = posts.filter(p => p.userEmail === user.email)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        if (userPosts.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          profilePosts.appendChild(empty);
        } else {
          userPosts.forEach(p => {
            const item = document.createElement("div");
            item.className = "meal-item";

            const top = document.createElement("div");
            top.className = "meal-top";
            const left = document.createElement("div");
            left.textContent = `${formatDate(p.date)} Â· ${typeLabel(p.type || "training")}`;
            const right = document.createElement("div");
            right.className = "tag-pill";
            right.textContent = visibilityLabel(p.visibility || "public");
            top.appendChild(left);
            top.appendChild(right);

            const main = document.createElement("div");
            main.className = "meal-main";
            const ex = p.exercise || (p.trainingSets && p.trainingSets[0]?.exercise) || "";
            const note = (p.note || "").slice(0, 40);
            main.textContent = [ex, note].filter(Boolean).join(" | ");

            item.appendChild(top);
            item.appendChild(main);
            profilePosts.appendChild(item);
          });
        }

        profileBackdrop.classList.remove("hidden");
      }

      profileClose.addEventListener("click", () => {
        profileBackdrop.classList.add("hidden");
      });
      profileBackdrop.addEventListener("click", (e) => {
        if (e.target === profileBackdrop) {
          profileBackdrop.classList.add("hidden");
        }
      });

      // ---- Search ----
      function openSearchModal() {
        searchInput.value = "";
        searchResults.innerHTML = "";
        searchBackdrop.classList.remove("hidden");
        setTimeout(() => searchInput.focus(), 0);
      }
      function closeSearchModal() {
        searchBackdrop.classList.add("hidden");
      }

      btnOpenSearch.addEventListener("click", openSearchModal);
      searchClose.addEventListener("click", closeSearchModal);
      searchBackdrop.addEventListener("click", (e) => {
        if (e.target === searchBackdrop) closeSearchModal();
      });

      function renderSearchResults(q) {
        searchResults.innerHTML = "";
        const query = (q || "").trim().toLowerCase();
        if (!query) return;

        const uRes = users.filter(u =>
          (u.handle || "").toLowerCase().includes(query) ||
          (u.email || "").toLowerCase().includes(query)
        );

        const pRes = posts.filter(p => {
          const owner = getUserByEmail(p.userEmail) || {};
          const textParts = [
            p.note || "",
            p.exercise || "",
            (p.trainingSets || []).map(s => s.exercise || "").join(" "),
            owner.handle || "",
          ].join(" ").toLowerCase();
          return textParts.includes(query);
        });

        if (uRes.length === 0 && pRes.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "ä¸€è‡´ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          searchResults.appendChild(empty);
          return;
        }

        function addSectionTitle(label, count) {
          const t = document.createElement("div");
          t.className = "search-section-title";
          t.textContent = `${label} (${count})`;
          searchResults.appendChild(t);
        }

        if (uRes.length) {
          addSectionTitle("Users", uRes.length);
          uRes.forEach(u => {
            const item = document.createElement("div");
            item.className = "people-item";
            item.style.cursor = "pointer";

            const row = document.createElement("div");
            row.className = "people-row";

            const main = document.createElement("div");
            main.className = "people-main";

            const h = document.createElement("div");
            h.textContent = `@${u.handle || "user"}`;

            const sub = document.createElement("div");
            sub.className = "people-sub";
            sub.textContent = u.email || "";

            main.appendChild(h);
            main.appendChild(sub);
            row.appendChild(main);
            item.appendChild(row);

            item.addEventListener("click", () => {
              openProfile(u.handle);
              closeSearchModal();
            });

            searchResults.appendChild(item);
          });
        }

        if (pRes.length) {
          addSectionTitle("Posts", pRes.length);
          pRes
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
            .forEach(p => {
              const owner = getUserByEmail(p.userEmail) || {};
              const item = document.createElement("div");
              item.className = "meal-item";

              const top = document.createElement("div");
              top.className = "meal-top";

              const left = document.createElement("div");
              left.textContent = `@${owner.handle || "user"} Â· ${formatDate(p.date)}`;

              const right = document.createElement("div");
              right.className = "tag-pill";
              right.textContent = typeLabel(p.type || "training");

              top.appendChild(left);
              top.appendChild(right);

              const main = document.createElement("div");
              main.className = "meal-main";
              const ex = p.exercise || (p.trainingSets && p.trainingSets[0]?.exercise) || "";
              const note = (p.note || "").slice(0, 40);
              main.textContent = [ex, note].filter(Boolean).join(" | ");

              item.appendChild(top);
              item.appendChild(main);

              searchResults.appendChild(item);
            });
        }
      }

      searchInput.addEventListener("input", () => {
        renderSearchResults(searchInput.value);
      });
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          renderSearchResults(searchInput.value);
        }
      });

      // ---- Language ----
      langSelect.addEventListener("change", () => {
        const lang = langSelect.value === "en" ? "en" : "ja";
        applyLanguage(lang);
      });

      // ---- init ----
      function init() {
        loadUsers();
        loadPosts();
        loadConversations();
        loadMeals();
        loadGyms();
        loadCurrentUser();
        loadTheme();

        const lang = loadLanguage();
        langSelect.value = lang;
        applyLanguage(lang);

        const today = new Date().toISOString().slice(0, 10);
        if (postDate && !postDate.value) postDate.value = today;
        if (mealDate && !mealDate.value) mealDate.value = today;

        resetTrainingSets();
        updateNav();
        renderFeed();
        renderConvList();
        currentConvId = conversations[0]?.id || null;
        renderConvList();
        renderChat();
        renderPeopleList();
        renderMeals();
        renderGyms();
      }

      init();
    })();
  </script>
</body>
</html>
