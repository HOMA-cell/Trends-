<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Trends</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.12);
      --danger: #ef4444;
    }
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Yu Gothic",sans-serif;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 12px;
    }
    .app {
      width: 100%;
      max-width: 1100px;
      background: #f9fafb;
      border-radius: 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 90vh;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(15,23,42,0.08);
    }
    @media (max-width: 768px) {
      body { padding: 6px; }
      .app { border-radius: 14px; min-height: 92vh; }
    }

    /* topbar */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      gap: 8px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-logo {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--accent);
      font-weight: 700;
    }
    .brand-text-main {
      font-size: 16px;
      font-weight: 650;
    }
    .brand-text-sub {
      font-size: 11px;
      color: var(--muted);
    }
    .top-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .user-label {
      font-size: 11px;
      color: var(--muted);
    }
    .btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.07s ease;
    }
    .btn:hover {
      background: #f3f4f6;
      box-shadow: 0 6px 12px rgba(15,23,42,0.08);
      transform: translateY(-1px);
    }
    .btn.primary {
      border-color: transparent;
      background: linear-gradient(135deg,#3b82f6,#60a5fa);
      color: #ffffff;
      font-weight: 600;
      box-shadow: 0 10px 22px rgba(37,99,235,0.45);
    }
    .btn.small {
      padding: 4px 10px;
      font-size: 10px;
    }
    .btn.danger {
      border-color: var(--danger);
      color: var(--danger);
      background: #fef2f2;
    }
    .select {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
    }
    .hidden { display: none !important; }

    /* layout */
    .content {
      flex: 1;
      display: flex;
      gap: 10px;
      padding: 10px;
      overflow: hidden;
    }
    .main-column {
      flex: 2;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .side-column {
      flex: 1;
      min-width: 260px;
      max-width: 340px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    @media (max-width: 768px) {
      .content {
        flex-direction: column;
      }
      .side-column {
        max-width: 100%;
        min-width: 0;
      }
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 8px 10px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }
    .card-sub {
      font-size: 11px;
      color: var(--muted);
    }

    /* search & toolbar */
    .toolbar-top {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .input-pill {
      flex: 1;
      min-width: 140px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 9px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border);
    }
    .input-pill input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 11px;
      background: transparent;
    }
    .pill-group {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .pill-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      color: var(--muted);
    }
    .pill-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    /* posts */
    .feed {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: calc(100vh - 220px);
      overflow-y: auto;
      padding-right: 4px;
    }
    @media (max-width: 768px) {
      .feed { max-height: none; }
    }
    .post {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .post-head {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }
    .post-user {
      display: flex;
      gap: 6px;
      align-items: center;
      min-width: 0;
    }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      flex-shrink: 0;
    }
    .post-meta-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
    }
    .post-name {
      font-size: 12px;
      display: flex;
      gap: 6px;
      align-items: baseline;
    }
    .post-handle {
      font-size: 11px;
      color: var(--muted);
    }
    .post-sub {
      font-size: 10px;
      color: var(--muted);
    }
    .post-tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #f9fafb;
    }
    .post-body {
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .post-meta {
      font-size: 11px;
      color: var(--muted);
    }
    .media {
      margin-top: 4px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #f3f4f6;
    }
    .media-inner {
      position: relative;
      width: 100%;
      padding-top: 60%;
    }
    .media-inner img,
    .media-inner video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .post-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }
    .post-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .icon-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px;
      transition: transform 0.07s ease, opacity 0.07s ease;
    }
    .icon-btn:hover {
      transform: translateY(-1px);
      opacity: 0.8;
    }
    .likes-label {
      font-size: 11px;
      color: var(--muted);
    }
    .empty {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    .small-text {
      font-size: 11px;
      color: var(--muted);
    }

    /* side */
    .steps-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }
    .steps-list li {
      margin-left: 14px;
      list-style: decimal;
    }

    /* form */
    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    input, textarea, select {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 12px;
      outline: none;
      background: #ffffff;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }
    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 140px;
    }
    .field-row {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 6px;
    }
    @media (max-width: 480px) {
      .field-row { grid-template-columns: minmax(0,1fr); }
    }

    /* fab */
    .fab {
      position: fixed;
      right: 22px;
      bottom: 22px;
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg,#3b82f6,#60a5fa);
      color: #ffffff;
      font-size: 26px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 18px 40px rgba(37,99,235,0.4);
      z-index: 20;
    }
    @media (max-width: 768px) {
      .fab {
        right: 16px;
        bottom: 16px;
      }
    }

    /* modal */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 16px;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.25);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }
    .close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-logo">T</div>
        <div>
          <div class="brand-text-main">Trends</div>
          <div class="brand-text-sub" id="brand-sub">
            Workout only / ‰ΩôË®à„Å™SNS„Å™„Åó
          </div>
        </div>
      </div>
      <div class="top-right">
        <span class="user-label" id="user-label">Not logged in</span>
        <select id="lang-select" class="select">
          <option value="ja">Êó•Êú¨Ë™û</option>
          <option value="en">English</option>
        </select>
        <button id="btn-open-auth" class="btn primary">Login / Sign up</button>
        <button id="btn-logout" class="btn hidden">Logout</button>
      </div>
    </header>

    <main class="content">
      <!-- main -->
      <section class="main-column">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="dot"></span>
              <span id="feed-title">Feed</span>
            </div>
            <div class="small-text" id="feed-status">Login to post.</div>
          </div>

          <div class="toolbar-top">
            <div class="input-pill">
              <span>üîç</span>
              <input id="search-input" type="text" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ / „Éè„É≥„Éâ„É´„ÅßÊ§úÁ¥¢" />
            </div>
            <div class="pill-group">
              <button class="pill-btn active" data-filter="all" id="btn-filter-all">All</button>
              <button class="pill-btn" data-filter="mine" id="btn-filter-mine">Mine</button>
            </div>
          </div>

          <div class="feed" id="feed"></div>
          <div class="empty" id="feed-empty">
            „Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂè≥‰∏ã„ÅÆ„ÄåÔºã„Äç„Åã„ÇâÊúÄÂàù„ÅÆÊäïÁ®ø„Çí‰Ωú„Å£„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </div>
        </div>
      </section>

      <!-- side -->
      <aside class="side-column">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="dot"></span>
              <span id="side-howto-title">How to start</span>
            </div>
          </div>
          <ul class="steps-list" id="howto-list">
            <li>Âè≥‰∏ä„ÅÆ„ÄåLogin / Sign up„Äç„Åã„Çâ„É°„Éº„É´ÔºÜ„Éë„Çπ„ÉØ„Éº„Éâ„ÅßÁôªÈå≤</li>
            <li>Âè≥‰∏ã„ÅÆ„ÄåÔºã„Äç„Åã„Çâ„ÄÅ‰ΩìÈáç„Éª„É°„É¢„ÉªÂÜôÁúü„ÇíÊäïÁ®ø</li>
            <li>Ê§úÁ¥¢„ÅßÂèãÈÅî„ÅÆ„Éè„É≥„Éâ„É´„ÇÑ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊé¢„Åô</li>
          </ul>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="dot"></span>
              <span id="side-tips-title">Tips</span>
            </div>
          </div>
          <div class="small-text" id="side-tips-body">
            Physique Áî®„Å®„Éà„É¨„É°„É¢Áî®„Å†„Åë„Å´Áµû„Å£„ÅüSNS„Åß„Åô„ÄÇ<br/>
            „ÅÑ„ÅÑ„Å≠„ÅØ„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂ÂÜÖ„Å†„Åë„Åß‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ
          </div>
        </div>
      </aside>
    </main>

    <button class="fab" id="btn-open-post">Ôºã</button>
  </div>

  <!-- auth modal -->
  <div class="backdrop hidden" id="auth-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="auth-modal-title">Login / Sign up</div>
        <button class="close-btn" id="auth-close">‚úï</button>
      </div>
      <form id="auth-form">
        <div class="field-row">
          <label>
            Email
            <input type="email" id="auth-email" autocomplete="email" />
          </label>
          <label>
            Handle
            <input type="text" id="auth-handle" placeholder="‰æã: homare_pwr" autocomplete="username" />
          </label>
        </div>
        <label style="margin-top:4px;">
          Password
          <input type="password" id="auth-password" autocomplete="current-password" />
        </label>
        <div class="small-text" id="auth-hint">
          Âàù„ÇÅ„Å¶„ÅÆ„É°„Éº„É´„ÅÆÂ†¥Âêà„ÄÅËá™Âãï„Åß„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê ‚Üí „É≠„Ç∞„Ç§„É≥Êâ±„ÅÑ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
        </div>
        <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
          <button type="submit" class="btn primary" id="auth-submit">OK</button>
          <button type="button" class="btn small" id="auth-fill-demo">demo</button>
        </div>
        <div class="small-text" id="auth-status" style="margin-top:4px;"></div>
      </form>
    </div>
  </div>

  <!-- post modal -->
  <div class="backdrop hidden" id="post-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="post-modal-title">New post</div>
        <button class="close-btn" id="post-close">‚úï</button>
      </div>
      <form id="post-form">
        <div class="field-row">
          <label>
            Date
            <input type="date" id="post-date" />
          </label>
          <label>
            Bodyweight (kg)
            <input type="number" step="0.1" id="post-bodyweight" placeholder="‰æã: 77.4" />
          </label>
        </div>
        <label style="margin-top:4px;">
          Caption / Memo
          <textarea id="post-note" placeholder="‰ªäÊó•„ÅÆ„Éà„É¨ / ‰Ωì„ÅÆÁä∂ÊÖã / ÂèçÁúÅ„Å™„Å©"></textarea>
        </label>
        <label style="margin-top:4px;">
          Photo / video
          <input type="file" id="post-media-file" accept="image/*,video/*" />
        </label>
        <div class="small-text" id="post-hint">
          „Éï„Ç°„Ç§„É´„ÇíÈÅ∏„Å∞„Å™„Åë„Çå„Å∞„É°„É¢ÊäïÁ®ø„Å†„Åë„Å´„Å™„Çä„Åæ„Åô„ÄÇ
        </div>
        <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
          <button type="submit" class="btn primary" id="post-submit">Post</button>
          <button type="button" class="btn" id="post-reset">Reset</button>
        </div>
        <div class="small-text" id="post-status" style="margin-top:4px;"></div>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ====== Supabase client ======
    const supabaseUrl = "https://sfuroqxcljlkbthblqva.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdXJvcXhjbGpsa2J0aGJscXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTE0MTQsImV4cCI6MjA4MDc2NzQxNH0.v1qrjQgkPg3hPjIVCsKg3unwM0lvPGXkw8DvVm8YlRI";

    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // ====== DOM refs ======
    const userLabel = document.getElementById("user-label");
    const brandSub = document.getElementById("brand-sub");
    const feedTitle = document.getElementById("feed-title");
    const feedStatus = document.getElementById("feed-status");
    const feedEl = document.getElementById("feed");
    const feedEmpty = document.getElementById("feed-empty");
    const searchInput = document.getElementById("search-input");
    const btnFilterAll = document.getElementById("btn-filter-all");
    const btnFilterMine = document.getElementById("btn-filter-mine");
    const btnOpenPost = document.getElementById("btn-open-post");

    const langSelect = document.getElementById("lang-select");
    const sideHowtoTitle = document.getElementById("side-howto-title");
    const sideTipsTitle = document.getElementById("side-tips-title");
    const howtoList = document.getElementById("howto-list");
    const sideTipsBody = document.getElementById("side-tips-body");

    // auth modal
    const btnOpenAuth = document.getElementById("btn-open-auth");
    const btnLogout = document.getElementById("btn-logout");
    const authBackdrop = document.getElementById("auth-backdrop");
    const authClose = document.getElementById("auth-close");
    const authForm = document.getElementById("auth-form");
    const authEmail = document.getElementById("auth-email");
    const authHandle = document.getElementById("auth-handle");
    const authPassword = document.getElementById("auth-password");
    const authStatus = document.getElementById("auth-status");
    const authFillDemo = document.getElementById("auth-fill-demo");

    // post modal
    const postBackdrop = document.getElementById("post-backdrop");
    const postClose = document.getElementById("post-close");
    const postForm = document.getElementById("post-form");
    const postDate = document.getElementById("post-date");
    const postBodyweight = document.getElementById("post-bodyweight");
    const postNote = document.getElementById("post-note");
    const postMediaFile = document.getElementById("post-media-file");
    const postStatus = document.getElementById("post-status");
    const postReset = document.getElementById("post-reset");

    // ====== state ======
    let currentUser = null;
    let currentLang = "ja";
    let postsCache = [];
    let profilesMap = new Map();
    let filterMode = "all";
    let likedIds = new Set();

    // ====== util ======
    function formatDateTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${day} ${hh}:${mm}`;
    }
    function formatDateOnly(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}/${m}/${day}`;
    }
    function getHandle(uid) {
      return profilesMap.get(uid)?.handle || "user";
    }
    function getLikeStorageKey() {
      return currentUser ? `trends_likes_${currentUser.id}` : "trends_likes_guest";
    }
    function loadLikesFromStorage() {
      const key = getLikeStorageKey();
      const raw = localStorage.getItem(key);
      if (!raw) {
        likedIds = new Set();
        return;
      }
      try {
        const arr = JSON.parse(raw);
        likedIds = new Set(arr);
      } catch {
        likedIds = new Set();
      }
    }
    function saveLikesToStorage() {
      const key = getLikeStorageKey();
      localStorage.setItem(key, JSON.stringify(Array.from(likedIds)));
    }

    // ====== language ======
    function applyLanguage(lang) {
      currentLang = lang;
      if (lang === "ja") {
        brandSub.textContent = "Workout only / ‰ΩôË®à„Å™SNS„Å™„Åó";
        feedTitle.textContent = "Feed";
        feedStatus.textContent = currentUser ? "ÊäïÁ®ø„Åó„Å¶Ë®òÈå≤„ÇíÊÆã„Åù„ÅÜ„ÄÇ" : "„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®ÊäïÁ®ø„Åß„Åç„Åæ„Åô„ÄÇ";
        searchInput.placeholder = "„Ç≠„Éº„ÉØ„Éº„Éâ / „Éè„É≥„Éâ„É´„ÅßÊ§úÁ¥¢";
        btnFilterAll.textContent = "All";
        btnFilterMine.textContent = "Mine";
        sideHowtoTitle.textContent = "Âßã„ÇÅÊñπ";
        sideTipsTitle.textContent = "Tips";
        howtoList.innerHTML = `
          <li>Âè≥‰∏ä„ÅÆ„ÄåLogin / Sign up„Äç„Åã„Çâ„É°„Éº„É´ÔºÜ„Éë„Çπ„ÉØ„Éº„Éâ„ÅßÁôªÈå≤</li>
          <li>Âè≥‰∏ã„ÅÆ„ÄåÔºã„Äç„Åã„Çâ„ÄÅ‰ΩìÈáç„Éª„É°„É¢„ÉªÂÜôÁúü„ÇíÊäïÁ®ø</li>
          <li>Ê§úÁ¥¢„ÅßÂèãÈÅî„ÅÆ„Éè„É≥„Éâ„É´„ÇÑ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊé¢„Åô</li>
        `;
        sideTipsBody.innerHTML =
          "Physique Áî®„Å®„Éà„É¨„É°„É¢Áî®„Å†„Åë„Å´Áµû„Å£„ÅüSNS„Åß„Åô„ÄÇ<br/>„ÅÑ„ÅÑ„Å≠„ÅØ„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂ÂÜÖ„Å†„Åë„Åß‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ";
      } else {
        brandSub.textContent = "Workout only / no random feeds";
        feedTitle.textContent = "Feed";
        feedStatus.textContent = currentUser ? "Log your training & physique." : "Login to post.";
        searchInput.placeholder = "Search by keyword or handle";
        btnFilterAll.textContent = "All";
        btnFilterMine.textContent = "Mine";
        sideHowtoTitle.textContent = "How to start";
        sideTipsTitle.textContent = "Tips";
        howtoList.innerHTML = `
          <li>Use ‚ÄúLogin / Sign up‚Äù to create an account</li>
          <li>Post bodyweight / memo / photo from the ‚ÄúÔºã‚Äù button</li>
          <li>Search with keywords or friends‚Äô handles</li>
        `;
        sideTipsBody.innerHTML =
          "This SNS is only for workouts and physique logs.<br/>Likes are saved only in this browser.";
      }
      renderPosts();
    }

    langSelect.addEventListener("change", () => {
      applyLanguage(langSelect.value || "ja");
    });

    // ====== auth modal control ======
    function openAuthModal() {
      authStatus.textContent = "";
      authBackdrop.classList.remove("hidden");
    }
    function closeAuthModal() {
      authBackdrop.classList.add("hidden");
    }
    btnOpenAuth.addEventListener("click", openAuthModal);
    authClose.addEventListener("click", closeAuthModal);
    authBackdrop.addEventListener("click", (e) => {
      if (e.target === authBackdrop) closeAuthModal();
    });
    authFillDemo.addEventListener("click", () => {
      authEmail.value = "demo@example.com";
      authHandle.value = "demo_lifter";
      authPassword.value = "password123";
      authStatus.textContent = currentLang === "ja"
        ? "„ÉÜ„Çπ„ÉàÁî®„ÅÆÊÉÖÂ†±„ÇíÂÖ•„Çå„Åæ„Åó„Åü„ÄÇ"
        : "Demo credential filled.";
    });

    // ====== post modal control ======
    function openPostModal() {
      if (!currentUser) {
        openAuthModal();
        authStatus.textContent = currentLang === "ja"
          ? "ÊäïÁ®ø„Åô„Çã„Å´„ÅØÂÖà„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
          : "Please login first.";
        return;
      }
      postStatus.textContent = "";
      postBackdrop.classList.remove("hidden");
    }
    function closePostModal() {
      postBackdrop.classList.add("hidden");
    }
    btnOpenPost.addEventListener("click", openPostModal);
    postClose.addEventListener("click", closePostModal);
    postBackdrop.addEventListener("click", (e) => {
      if (e.target === postBackdrop) closePostModal();
    });

    function resetPostForm() {
      const today = new Date().toISOString().slice(0, 10);
      postDate.value = today;
      postBodyweight.value = "";
      postNote.value = "";
      postMediaFile.value = "";
      postStatus.textContent = "";
    }
    postReset.addEventListener("click", () => {
      resetPostForm();
      postStatus.textContent = currentLang === "ja" ? "„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ" : "Reset.";
    });

    // ====== auth logic (sign-in then sign-up fallback) ======
    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      authStatus.style.color = "var(--muted)";
      authStatus.textContent = "";

      const email = authEmail.value.trim();
      const handleRaw = authHandle.value.trim();
      const password = authPassword.value.trim();

      if (!email || !password) {
        authStatus.style.color = "var(--danger)";
        authStatus.textContent = currentLang === "ja"
          ? "Email „Å® Password „ÅØÂøÖÈ†à„Åß„Åô„ÄÇ"
          : "Email and password are required.";
        return;
      }

      const handle = handleRaw || email.split("@")[0];

      // 1) try sign-in
      let { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (signInError) {
        const msg = (signInError.message || "").toLowerCase();
        if (signInError.code === "invalid_credentials" || msg.includes("invalid login")) {
          // 2) fallback: sign-up as new user
          authStatus.textContent = currentLang === "ja"
            ? "Âàù„ÇÅ„Å¶„ÅÆÂà©Áî®„Å®„Åø„Å™„Åó„Å¶„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô‚Ä¶"
            : "No account found, creating one‚Ä¶";

          const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
            email,
            password,
            options: { data: { handle } },
          });

          if (signUpError) {
            authStatus.style.color = "var(--danger)";
            authStatus.textContent = currentLang === "ja"
              ? `„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${signUpError.message}`
              : `Sign up failed: ${signUpError.message}`;
            console.error("signUp error", signUpError);
            return;
          }

          // „Çµ„Ç§„É≥„Ç¢„ÉÉ„ÉóÁõ¥Âæå„Å´ getUser „ÅßÁ¢∫Ë™ç
          const { data: userRes } = await supabase.auth.getUser();
          const user = userRes?.user || signUpData.user;
          if (!user) {
            authStatus.style.color = "var(--danger)";
            authStatus.textContent = currentLang === "ja"
              ? "„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó„ÅØÊàêÂäü„Åó„Åæ„Åó„Åü„Åå„ÄÅ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„É°„Éº„É´Ë™çË®º„ÅåÂøÖË¶Å„Å™ÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ"
              : "Sign up succeeded but user is null. Maybe email confirmation is required.";
            return;
          }

          // profiles „Å´ upsert
          await supabase.from("profiles").upsert({
            id: user.id,
            handle,
          });

          currentUser = { id: user.id, email, handle };
          authStatus.style.color = "var(--text)";
          authStatus.textContent = currentLang === "ja"
            ? "„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê & „É≠„Ç∞„Ç§„É≥ÂÆå‰∫ÜÔºÅ"
            : "Account created & logged in!";
          await afterLoginRefresh();
          closeAuthModal();
          return;
        }

        // ‰ªñ„ÅÆ„Ç®„É©„Éº
        authStatus.style.color = "var(--danger)";
        authStatus.textContent = currentLang === "ja"
          ? `„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${signInError.message}`
          : `Login failed: ${signInError.message}`;
        console.error("signIn error", signInError);
        return;
      }

      // sign-in succeeded
      const user = signInData.user;
      if (!user) {
        authStatus.style.color = "var(--danger)";
        authStatus.textContent = currentLang === "ja"
          ? "„É≠„Ç∞„Ç§„É≥„ÅØÊàêÂäü„Åó„Åæ„Åó„Åü„Åå„ÄÅ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ"
          : "Login succeeded but user is null.";
        return;
      }

      // profiles „Åã„Çâ handle „ÇíÂèñÂæó or ‰ΩúÊàê
      let profileHandle = handle;
      const { data: existingProfile, error: profileError } = await supabase
        .from("profiles")
        .select("handle")
        .eq("id", user.id)
        .maybeSingle();

      if (!profileError && existingProfile && existingProfile.handle) {
        profileHandle = existingProfile.handle;
      } else {
        await supabase.from("profiles").upsert({
          id: user.id,
          handle: profileHandle,
        });
      }

      currentUser = { id: user.id, email, handle: profileHandle };
      authStatus.style.color = "var(--text)";
      authStatus.textContent = currentLang === "ja"
        ? "„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü„ÄÇ"
        : "Logged in.";
      await afterLoginRefresh();
      closeAuthModal();
    });

    btnLogout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      currentUser = null;
      profilesMap.clear();
      postsCache = [];
      likedIds = new Set();
      updateNav();
      renderPosts();
    });

    // ====== posts load & render ======
    async function fetchProfilesMap(userIds) {
      if (!userIds || userIds.length === 0) return;
      const unique = Array.from(new Set(userIds));
      const { data, error } = await supabase
        .from("profiles")
        .select("id,handle")
        .in("id", unique);

      if (error) {
        console.error("profiles select error", error);
        return;
      }
      data.forEach(p => {
        profilesMap.set(p.id, { handle: p.handle || "user" });
      });
    }

    async function loadPosts() {
      const { data, error } = await supabase
        .from("posts")
        .select("id,user_id,created_at,note,bodyweight,media_url,date")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("posts select error", error);
        feedStatus.textContent = currentLang === "ja"
          ? `ÊäïÁ®ø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`
          : `Failed to load posts: ${error.message}`;
        return;
      }
      postsCache = data || [];

      const userIds = postsCache.map(p => p.user_id).filter(Boolean);
      await fetchProfilesMap(userIds);

      renderPosts();
    }

    function renderPosts() {
      feedEl.innerHTML = "";
      if (!postsCache || postsCache.length === 0) {
        feedEmpty.classList.remove("hidden");
        return;
      }
      feedEmpty.classList.add("hidden");

      const q = (searchInput.value || "").trim().toLowerCase();
      const isMine = filterMode === "mine";
      const uid = currentUser?.id;

      const filtered = postsCache.filter(p => {
        if (isMine && uid && p.user_id !== uid) return false;
        if (!q) return true;

        const handle = getHandle(p.user_id).toLowerCase();
        const note = (p.note || "").toLowerCase();
        const bw = p.bodyweight ? String(p.bodyweight) : "";
        return (
          handle.includes(q) ||
          note.includes(q) ||
          bw.includes(q)
        );
      });

      filtered.forEach(post => {
        const card = document.createElement("article");
        card.className = "post";

        const head = document.createElement("div");
        head.className = "post-head";

        const left = document.createElement("div");
        left.className = "post-user";

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        const h = getHandle(post.user_id);
        avatar.textContent = (h || "U").charAt(0).toUpperCase();

        const metaText = document.createElement("div");
        metaText.className = "post-meta-text";
        const nameRow = document.createElement("div");
        nameRow.className = "post-name";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = h || "user";
        const handleSpan = document.createElement("span");
        handleSpan.className = "post-handle";
        handleSpan.textContent = `@${h || "user"}`;
        nameRow.appendChild(nameSpan);
        nameRow.appendChild(handleSpan);

        const sub = document.createElement("div");
        sub.className = "post-sub";
        const dateLabel = post.date ? formatDateOnly(post.date) : "";
        sub.textContent = dateLabel
          ? `${dateLabel} ¬∑ ${formatDateTime(post.created_at)}`
          : formatDateTime(post.created_at);

        metaText.appendChild(nameRow);
        metaText.appendChild(sub);

        left.appendChild(avatar);
        left.appendChild(metaText);

        const right = document.createElement("div");
        const tag = document.createElement("span");
        tag.className = "post-tag";
        tag.textContent = post.media_url
          ? (currentLang === "ja" ? "Physique" : "Physique")
          : (currentLang === "ja" ? "Memo" : "Memo");
        right.appendChild(tag);

        head.appendChild(left);
        head.appendChild(right);

        const body = document.createElement("div");
        body.className = "post-body";
        body.textContent = post.note || "";

        card.appendChild(head);
        card.appendChild(body);

        if (post.bodyweight) {
          const meta = document.createElement("div");
          meta.className = "post-meta";
          meta.textContent =
            currentLang === "ja"
              ? `‰ΩìÈáç: ${post.bodyweight} kg`
              : `Bodyweight: ${post.bodyweight} kg`;
          card.appendChild(meta);
        }

        if (post.media_url) {
          const media = document.createElement("div");
          media.className = "media";
          const inner = document.createElement("div");
          inner.className = "media-inner";

          const url = post.media_url;
          if (url.match(/\.(mp4|mov|webm)$/i)) {
            const v = document.createElement("video");
            v.src = url;
            v.controls = true;
            inner.appendChild(v);
          } else {
            const img = document.createElement("img");
            img.src = url;
            img.alt = "media";
            inner.appendChild(img);
          }

          media.appendChild(inner);
          card.appendChild(media);
        }

        const footer = document.createElement("div");
        footer.className = "post-footer";

        const actions = document.createElement("div");
        actions.className = "post-actions";

        // like
        const likeBtn = document.createElement("button");
        likeBtn.className = "icon-btn";
        const liked = likedIds.has(post.id);
        likeBtn.textContent = liked ? "üíô" : "ü§ç";
        likeBtn.addEventListener("click", () => {
          if (likedIds.has(post.id)) {
            likedIds.delete(post.id);
          } else {
            likedIds.add(post.id);
          }
          saveLikesToStorage();
          renderPosts();
        });
        actions.appendChild(likeBtn);

        const likesLabel = document.createElement("div");
        likesLabel.className = "likes-label";
        likesLabel.textContent = liked
          ? (currentLang === "ja" ? "„ÅÑ„ÅÑ„Å≠Ê∏à„Åø" : "Liked")
          : (currentLang === "ja" ? "„ÅÑ„ÅÑ„Å≠" : "Like");
        actions.appendChild(likesLabel);

        footer.appendChild(actions);

        // own post delete
        if (currentUser && currentUser.id === post.user_id) {
          const delBtn = document.createElement("button");
          delBtn.className = "btn small";
          delBtn.textContent = currentLang === "ja" ? "ÂâäÈô§" : "Delete";
          delBtn.addEventListener("click", async () => {
            const yes = confirm(
              currentLang === "ja"
                ? "„Åì„ÅÆÊäïÁ®ø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü"
                : "Delete this post?"
            );
            if (!yes) return;
            const { error } = await supabase
              .from("posts")
              .delete()
              .eq("id", post.id);

            if (error) {
              alert(
                currentLang === "ja"
                  ? `ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`
                  : `Failed to delete: ${error.message}`
              );
              return;
            }
            postsCache = postsCache.filter(p => p.id !== post.id);
            renderPosts();
          });
          footer.appendChild(delBtn);
        }

        card.appendChild(footer);

        feedEl.appendChild(card);
      });

      if (filtered.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent =
          currentLang === "ja"
            ? "Êù°‰ª∂„Å´Âêà„ÅÜÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ"
            : "No posts match the filters.";
        feedEl.appendChild(empty);
      }
    }

    // ====== create post ======
    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      postStatus.style.color = "var(--muted)";
      postStatus.textContent = "";

      if (!currentUser) {
        postStatus.style.color = "var(--danger)";
        postStatus.textContent = currentLang === "ja"
          ? "ÊäïÁ®ø„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ"
          : "Please login first.";
        return;
      }

      const dateVal = postDate.value || null;
      const bwVal = postBodyweight.value ? Number(postBodyweight.value) : null;
      const noteVal = postNote.value.trim();

      const file = postMediaFile.files[0];
      let mediaUrl = null;

      try {
        if (file) {
          const ext = file.name.split(".").pop();
          const path = `${currentUser.id}/${Date.now()}.${ext}`;
          const { error: uploadError } = await supabase
            .storage
            .from("post-media")
            .upload(path, file, { upsert: false });

          if (uploadError) {
            console.error("upload error", uploadError);
            postStatus.style.color = "var(--danger)";
            postStatus.textContent = currentLang === "ja"
              ? `„Éï„Ç°„Ç§„É´„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${uploadError.message}`
              : `Upload failed: ${uploadError.message}`;
            return;
          }

          const { data: publicData } = supabase
            .storage
            .from("post-media")
            .getPublicUrl(path);
          mediaUrl = publicData.publicUrl;
        }

        if (!noteVal && !mediaUrl && !bwVal) {
          postStatus.style.color = "var(--danger)";
          postStatus.textContent = currentLang === "ja"
            ? "„É°„É¢ / ‰ΩìÈáç / ÂÜôÁúü„ÅÆ„Å©„Çå„Åã„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            : "Write a memo, bodyweight, or attach media.";
          return;
        }

        const { data, error } = await supabase
          .from("posts")
          .insert({
            user_id: currentUser.id,
            date: dateVal,
            bodyweight: bwVal,
            note: noteVal || "",
            media_url: mediaUrl,
          })
          .select()
          .single();

        if (error) {
          console.error("insert error", error);
          postStatus.style.color = "var(--danger)";
          postStatus.textContent = currentLang === "ja"
            ? `ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`
            : `Failed to post: ${error.message}`;
          return;
        }

        postsCache.unshift(data);
        await fetchProfilesMap([currentUser.id]);
        renderPosts();
        postStatus.style.color = "var(--text)";
        postStatus.textContent = currentLang === "ja"
          ? "ÊäïÁ®ø„Åó„Åæ„Åó„Åü„ÄÇ"
          : "Posted.";
        resetPostForm();
        setTimeout(closePostModal, 300);
      } catch (err) {
        console.error(err);
        postStatus.style.color = "var(--danger)";
        postStatus.textContent = currentLang === "ja"
          ? "‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ"
          : "Unexpected error.";
      }
    });

    // ====== nav / after login ======
    function updateNav() {
      if (currentUser) {
        userLabel.textContent = `@${currentUser.handle} ¬∑ ${currentUser.email}`;
        btnOpenAuth.classList.add("hidden");
        btnLogout.classList.remove("hidden");
        feedStatus.textContent =
          currentLang === "ja" ? "ÊäïÁ®ø„Åó„Å¶Ë®òÈå≤„ÇíÊÆã„Åù„ÅÜ„ÄÇ" : "Log your training & physique.";
      } else {
        userLabel.textContent = "Not logged in";
        btnOpenAuth.classList.remove("hidden");
        btnLogout.classList.add("hidden");
        feedStatus.textContent =
          currentLang === "ja" ? "„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å®ÊäïÁ®ø„Åß„Åç„Åæ„Åô„ÄÇ" : "Login to post.";
      }
    }

    async function afterLoginRefresh() {
      updateNav();
      loadLikesFromStorage();
      await loadPosts();
    }

    // ====== filters & search ======
    searchInput.addEventListener("input", () => {
      renderPosts();
    });
    btnFilterAll.addEventListener("click", () => {
      filterMode = "all";
      btnFilterAll.classList.add("active");
      btnFilterMine.classList.remove("active");
      renderPosts();
    });
    btnFilterMine.addEventListener("click", () => {
      filterMode = "mine";
      btnFilterMine.classList.add("active");
      btnFilterAll.classList.remove("active");
      renderPosts();
    });

    // ====== init ======
    async function init() {
      const today = new Date().toISOString().slice(0, 10);
      if (!postDate.value) postDate.value = today;

      const { data } = await supabase.auth.getUser();
      const user = data?.user || null;
      if (user) {
        // profiles „Åã„Çâ handle
        let handle = user.email?.split("@")[0] || "user";
        const { data: profile, error } = await supabase
          .from("profiles")
          .select("handle")
          .eq("id", user.id)
          .maybeSingle();
        if (!error && profile && profile.handle) {
          handle = profile.handle;
        }
        currentUser = { id: user.id, email: user.email, handle };
      }

      loadLikesFromStorage();
      updateNav();
      await loadPosts();
      applyLanguage("ja");
    }

    init();
  </script>
</body>
</html>