<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Trends | 筋トレ専用SNS プロトタイプ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", Arial, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
    }
    header {
      width: 100%;
      max-width: 1100px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .logo {
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #2563eb;
    }
    .lang-select {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }
    select,
    input,
    textarea,
    button {
      font-family: inherit;
    }
    select,
    input,
    textarea {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 0.9rem;
      width: 100%;
    }
    textarea {
      min-height: 72px;
      resize: vertical;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .layout {
      width: 100%;
      max-width: 1100px;
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) minmax(260px, 1fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 8px 30px rgba(15, 23, 42, 0.06);
    }
    .card + .card {
      margin-top: 10px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .section-sub {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 8px;
    }
    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      margin-bottom: 8px;
    }
    .field label {
      font-size: 0.8rem;
      display: block;
      margin-bottom: 3px;
      color: #4b5563;
    }
    .field input[type="file"] {
      padding: 0;
      border: none;
      background: transparent;
      font-size: 0.8rem;
    }
    .secondary-input {
      margin-top: 4px;
      font-size: 0.8rem;
      padding: 6px 9px;
    }

    .media-preview {
      margin-top: 6px;
    }
    .media-preview img,
    .media-preview video {
      max-width: 100%;
      border-radius: 12px;
      display: block;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .error-text {
      color: #b91c1c;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .info-text {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .feed-toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .feed-toolbar small {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .feed-list {
      margin-top: 8px;
    }
    .post-card {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      margin-bottom: 8px;
      background: #f9fafb;
    }
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .post-user {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }
    .avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #2563eb;
      color: #fff;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .post-meta {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .badge {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }
    .badge-public {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .badge-private {
      background: #fef3c7;
      color: #b45309;
    }
    .post-body {
      font-size: 0.9rem;
      margin-top: 4px;
      white-space: pre-wrap;
    }
    .post-body strong {
      font-weight: 600;
    }
    .post-footer {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .account-box small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .account-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
    }

    .debug-card {
      margin-top: 8px;
    }
    .debug-card button {
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="logo-mark">Tr</div>
        <span>Trends</span>
      </div>
      <div class="lang-select">
        <span id="labelLanguage">言語</span>
        <select id="languageSelect">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
      </div>
    </header>

    <main class="layout">
      <!-- Feed / new post -->
      <section>
        <div class="card">
          <div class="section-title" id="labelFeedTitle">Feed</div>
          <div class="section-sub" id="labelFeedSub">
            トレーニング記録・メモ・写真を残すタイムライン。
          </div>

          <!-- New post form -->
          <div id="newPostForm">
            <div class="form-row">
              <div class="field">
                <label for="postDate" id="labelDate">日付</label>
                <input id="postDate" type="date" />
              </div>
              <div class="field">
                <label for="postBodyweight" id="labelBodyweight">体重 (kg)</label>
                <input
                  id="postBodyweight"
                  type="number"
                  step="0.1"
                  inputmode="decimal"
                  placeholder="77.4"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="postVisibility" id="labelVisibility">公開範囲</label>
                <select id="postVisibility">
                  <option value="public">Public</option>
                  <option value="private">自分のみ</option>
                </select>
              </div>

              <div class="field">
                <label for="postMediaFile" id="labelMedia">写真 / 動画</label>
                <input
                  id="postMediaFile"
                  type="file"
                  accept="image/*,video/*"
                />
                <input
                  id="postMediaUrl"
                  type="url"
                  placeholder="外部URLを貼りたい場合のみ"
                  class="secondary-input"
                />
                <div id="mediaPreview" class="media-preview"></div>
              </div>
            </div>

            <div class="field">
              <label for="postNote" id="labelNote">キャプション / トレーニングメモ</label>
              <textarea id="postNote" placeholder="bench 100kg"></textarea>
            </div>

            <div class="form-actions">
              <button id="btnSubmitPost" class="btn-primary">
                <span id="labelPostButton">投稿</span>
              </button>
              <button id="btnResetPost" class="btn-secondary" type="button">
                <span id="labelResetButton">リセット</span>
              </button>
              <span id="postStatus" class="info-text"></span>
            </div>
            <div id="postError" class="error-text"></div>
          </div>
        </div>

        <!-- Feed list -->
        <div class="card" style="margin-top: 12px">
          <div class="feed-toolbar">
            <select id="feedFilter" style="max-width: 120px">
              <option value="all">すべて</option>
              <option value="mine">自分のみ</option>
              <option value="public">Publicのみ</option>
            </select>
            <input
              id="feedSearch"
              type="search"
              placeholder="caption / メモ / handle で検索"
            />
            <small id="feedCountLabel">0 posts</small>
          </div>
          <div id="feedList" class="feed-list"></div>
        </div>
      </section>

      <!-- Account / debug -->
      <aside>
        <div class="card account-box">
          <div class="section-title" id="labelAccountTitle">アカウント</div>
          <div class="section-sub" id="labelAccountSub">
            メール & パスワードでログイン / サインアップ。
          </div>

          <div class="account-row" id="authControls">
            <input id="authEmail" type="email" placeholder="email@example.com" />
            <input
              id="authPassword"
              type="password"
              placeholder="password"
            />
            <button id="btnAuth" class="btn-primary">
              <span id="labelAuthButton">Log in / Sign up</span>
            </button>
          </div>

          <div class="account-row" id="loggedInInfo" style="display: none">
            <small id="currentUserLabel"></small>
            <div style="display: flex; gap: 8px">
              <button id="btnReloadFeed" class="btn-secondary" type="button">
                Reload feed
              </button>
              <button id="btnLogout" class="btn-secondary" type="button">
                Log out
              </button>
            </div>
          </div>

          <div id="authError" class="error-text"></div>
        </div>

        <div class="card debug-card">
          <div class="section-title">Debug / Dev</div>
          <div class="section-sub">
            今は単一ページのプロトタイプです。挙動テスト用。
          </div>
          <button id="btnClearCache" class="btn-secondary" type="button">
            Clear local cache
          </button>
        </div>
      </aside>
    </main>
  </div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ==== Supabase 初期化 ====
    const SUPABASE_URL = "https://sfuroqxcljlkbthblqva.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdXJvcXhjbGpsa2J0aGJscXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTE0MTQsImV4cCI6MjA4MDc2NzQxNH0.v1qrjQgkPg3hPjIVCsKg3unwM0lvPGXkw8DvVm8YlRI";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    let currentUser = null;
    let allPosts = [];

    // ==== 多言語ラベル ====
    const i18n = {
      ja: {
        language: "言語",
        feedTitle: "Feed",
        feedSub: "トレーニング記録・メモ・写真を残すタイムライン。",
        date: "日付",
        bodyweight: "体重 (kg)",
        visibility: "公開範囲",
        media: "写真 / 動画",
        note: "キャプション / トレーニングメモ",
        postButton: "投稿",
        resetButton: "リセット",
        accountTitle: "アカウント",
        accountSub: "メール & パスワードでログイン / サインアップ。",
        authButton: "Log in / Sign up",
      },
      en: {
        language: "Language",
        feedTitle: "Feed",
        feedSub: "Timeline for logging your training, notes, and photos.",
        date: "Date",
        bodyweight: "Bodyweight (kg)",
        visibility: "Visibility",
        media: "Photo / Video",
        note: "Caption / Training notes",
        postButton: "Post",
        resetButton: "Reset",
        accountTitle: "Account",
        accountSub: "Log in / sign up with email and password.",
        authButton: "Log in / Sign up",
      },
    };

    function applyLanguage(lang) {
      const t = i18n[lang] || i18n.ja;
      document.getElementById("labelLanguage").textContent = t.language;
      document.getElementById("labelFeedTitle").textContent = t.feedTitle;
      document.getElementById("labelFeedSub").textContent = t.feedSub;
      document.getElementById("labelDate").textContent = t.date;
      document.getElementById("labelBodyweight").textContent = t.bodyweight;
      document.getElementById("labelVisibility").textContent = t.visibility;
      document.getElementById("labelMedia").textContent = t.media;
      document.getElementById("labelNote").textContent = t.note;
      document.getElementById("labelPostButton").textContent = t.postButton;
      document.getElementById("labelResetButton").textContent = t.resetButton;
      document.getElementById("labelAccountTitle").textContent = t.accountTitle;
      document.getElementById("labelAccountSub").textContent = t.accountSub;
      document.getElementById("labelAuthButton").textContent = t.authButton;
    }

    // ==== ユーティリティ ====
    function setToday() {
      const input = document.getElementById("postDate");
      const today = new Date();
      const iso = today.toISOString().slice(0, 10);
      input.value = iso;
    }

    function showPostError(msg) {
      document.getElementById("postError").textContent = msg || "";
    }
    function showPostStatus(msg) {
      document.getElementById("postStatus").textContent = msg || "";
    }
    function showAuthError(msg) {
      document.getElementById("authError").textContent = msg || "";
    }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      const y = d.getFullYear();
      const m = (d.getMonth() + 1).toString().padStart(2, "0");
      const day = d.getDate().toString().padStart(2, "0");
      return `${y}/${m}/${day}`;
    }

    function renderMediaHtml(post) {
      if (!post.media_url) return "";
      const type = post.media_type || "";
      if (type.startsWith("video")) {
        return `<video src="${post.media_url}" controls></video>`;
      }
      if (type.startsWith("image")) {
        return `<img src="${post.media_url}" alt="media" />`;
      }
      // その他はリンクとして扱う
      return `<a href="${post.media_url}" target="_blank" rel="noopener noreferrer">メディアを開く</a>`;
    }

    async function uploadMediaToStorage(file, userId) {
      const bucket = "post-media";
      const ext = file.name.split(".").pop() || "bin";
      const path = `${userId}/${Date.now()}.${ext}`;

      const { data, error } = await supabase.storage
        .from(bucket)
        .upload(path, file, {
          cacheControl: "3600",
          upsert: false,
        });
      if (error) {
        throw error;
      }

      const { data: publicData } = supabase.storage
        .from(bucket)
        .getPublicUrl(path);

      const url = publicData?.publicUrl || null;
      const type = file.type || "";
      return { url, type };
    }

    // ==== 投稿読み込み & レンダリング ====
    async function loadPosts() {
      if (!currentUser) {
        allPosts = [];
        renderPosts();
        return;
      }

      const { data, error } = await supabase
        .from("posts")
        .select("*")
        .order("date", { ascending: false })
        .order("created_at", { ascending: false });

      if (error) {
        console.error("loadPosts error", error);
        showPostError("Feed の読み込みに失敗しました。");
        return;
      }
      allPosts = data || [];
      renderPosts();
    }

    function renderPosts() {
      const list = document.getElementById("feedList");
      const filter = document.getElementById("feedFilter").value;
      const q = document.getElementById("feedSearch").value.trim().toLowerCase();

      let posts = allPosts.slice();

      if (filter === "mine" && currentUser) {
        posts = posts.filter((p) => p.user_id === currentUser.id);
      } else if (filter === "public") {
        posts = posts.filter((p) => p.visibility === "public");
      }

      if (q) {
        posts = posts.filter((p) => {
          const note = (p.note || "").toLowerCase();
          const bw = (p.bodyweight || "").toString().toLowerCase();
          const id = (p.user_id || "").toLowerCase();
          return (
            note.includes(q) ||
            bw.includes(q) ||
            id.includes(q)
          );
        });
      }

      document.getElementById(
        "feedCountLabel"
      ).textContent = `${posts.length} posts`;

      if (!posts.length) {
        list.innerHTML =
          '<div class="info-text">まだ投稿がありません。</div>';
        return;
      }

      const html = posts
        .map((p) => {
          const initials = (p.user_id || "?").slice(0, 2).toUpperCase();
          const dateLabel = formatDate(p.date || p.created_at);
          const bwLabel = p.bodyweight
            ? `<strong>${p.bodyweight}kg</strong>`
            : "";
          const vis =
            p.visibility === "public"
              ? '<span class="badge badge-public">Public</span>'
              : '<span class="badge badge-private">自分のみ</span>';

          return `
          <article class="post-card">
            <div class="post-header">
              <div class="post-user">
                <div class="avatar">${initials}</div>
                <div>
                  <div>@${(p.user_id || "").slice(0, 8)}</div>
                  <div class="post-meta">${dateLabel}</div>
                </div>
              </div>
              ${vis}
            </div>
            ${
              bwLabel
                ? `<div class="post-body">${bwLabel}</div>`
                : ""
            }
            ${
              p.note
                ? `<div class="post-body">${escapeHtml(p.note)}</div>`
                : ""
            }
            ${
              p.media_url
                ? `<div class="media-preview" style="margin-top:6px;">${renderMediaHtml(
                    p
                  )}</div>`
                : ""
            }
          </article>
        `;
        })
        .join("");

      list.innerHTML = html;
    }

    function escapeHtml(str) {
      if (!str) return "";
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // ==== 投稿送信 ====
    async function handlePostSubmit() {
      showPostError("");
      showPostStatus("");

      if (!currentUser) {
        showPostError("投稿するにはログインしてください。");
        return;
      }

      const dateInput = document.getElementById("postDate");
      const bwInput = document.getElementById("postBodyweight");
      const noteInput = document.getElementById("postNote");
      const visSelect = document.getElementById("postVisibility");
      const mediaFileInput = document.getElementById("postMediaFile");
      const mediaUrlInput = document.getElementById("postMediaUrl");

      const date = dateInput.value || null;
      const bodyweight = bwInput.value ? Number(bwInput.value) : null;
      const note = noteInput.value.trim();
      const visibility = visSelect.value || "public";

      if (!date && !note && !bodyweight && !mediaFileInput.files[0]) {
        showPostError("何か1つは入力してください。");
        return;
      }

      showPostStatus("投稿中...");
      let mediaUrl = null;
      let mediaType = null;

      const file = mediaFileInput.files[0];

      try {
        if (file) {
          const uploaded = await uploadMediaToStorage(file, currentUser.id);
          mediaUrl = uploaded.url;
          mediaType = uploaded.type;
        } else if (mediaUrlInput.value.trim()) {
          mediaUrl = mediaUrlInput.value.trim();
          mediaType = "external";
        }

        const { error } = await supabase.from("posts").insert([
          {
            user_id: currentUser.id,
            date,
            bodyweight,
            note,
            media_url: mediaUrl,
            media_type: mediaType,
            visibility,
          },
        ]);

        if (error) {
          console.error("insert error", error);
          showPostError("投稿に失敗しました。");
          showPostStatus("");
          return;
        }

        // clear
        noteInput.value = "";
        mediaFileInput.value = "";
        mediaUrlInput.value = "";
        document.getElementById("mediaPreview").innerHTML = "";
        showPostStatus("投稿しました。");
        await loadPosts();
      } catch (e) {
        console.error("post submit error", e);
        showPostError("メディアのアップロードまたは投稿に失敗しました。");
        showPostStatus("");
      }
    }

    function handlePostReset() {
      setToday();
      document.getElementById("postBodyweight").value = "";
      document.getElementById("postNote").value = "";
      document.getElementById("postMediaFile").value = "";
      document.getElementById("postMediaUrl").value = "";
      document.getElementById("mediaPreview").innerHTML = "";
      showPostError("");
      showPostStatus("");
    }

    // ==== Auth ====
    async function handleAuth() {
      showAuthError("");

      const email = document.getElementById("authEmail").value.trim();
      const password = document
        .getElementById("authPassword")
        .value.trim();

      if (!email || !password) {
        showAuthError("Email と password を入力してください。");
        return;
      }

      // まず login を試す。ダメなら sign up
      const { data: signInData, error: signInError } =
        await supabase.auth.signInWithPassword({
          email,
          password,
        });

      if (signInError) {
        // 新規ユーザーかもしれないので signUp を試す
        const { data: signUpData, error: signUpError } =
          await supabase.auth.signUp({
            email,
            password,
          });

        if (signUpError) {
          console.error("auth error", signInError, signUpError);
          showAuthError("ログイン / サインアップに失敗しました。");
          return;
        } else {
          currentUser = signUpData.user;
          updateAuthUI();
          await loadPosts();
          return;
        }
      } else {
        currentUser = signInData.user;
        updateAuthUI();
        await loadPosts();
      }
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      currentUser = null;
      updateAuthUI();
      allPosts = [];
      renderPosts();
    }

    function updateAuthUI() {
      const authControls = document.getElementById("authControls");
      const loggedInInfo = document.getElementById("loggedInInfo");
      const newPostForm = document.getElementById("newPostForm");

      if (currentUser) {
        authControls.style.display = "none";
        loggedInInfo.style.display = "flex";
        newPostForm.style.opacity = "1";
        newPostForm.style.pointerEvents = "auto";
        document.getElementById(
          "currentUserLabel"
        ).textContent = `ログイン中: ${currentUser.email || currentUser.id}`;
      } else {
        authControls.style.display = "flex";
        loggedInInfo.style.display = "none";
        newPostForm.style.opacity = "0.5";
        newPostForm.style.pointerEvents = "none";
        document.getElementById("currentUserLabel").textContent = "";
      }
    }

    // ==== イベント登録 & 初期化 ====
    async function init() {
      // language
      const langSelect = document.getElementById("languageSelect");
      const savedLang =
        localStorage.getItem("trends-lang") || "ja";
      langSelect.value = savedLang;
      applyLanguage(savedLang);
      langSelect.addEventListener("change", () => {
        const lang = langSelect.value;
        localStorage.setItem("trends-lang", lang);
        applyLanguage(lang);
      });

      setToday();

      // media preview
      const mediaFileInput = document.getElementById("postMediaFile");
      const mediaPreview = document.getElementById("mediaPreview");
      mediaFileInput.addEventListener("change", () => {
        mediaPreview.innerHTML = "";
        const file = mediaFileInput.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        if (file.type.startsWith("video")) {
          const v = document.createElement("video");
          v.src = url;
          v.controls = true;
          mediaPreview.appendChild(v);
        } else {
          const img = document.createElement("img");
          img.src = url;
          mediaPreview.appendChild(img);
        }
      });

      // buttons
      document
        .getElementById("btnSubmitPost")
        .addEventListener("click", (e) => {
          e.preventDefault();
          handlePostSubmit();
        });
      document
        .getElementById("btnResetPost")
        .addEventListener("click", (e) => {
          e.preventDefault();
          handlePostReset();
        });
      document
        .getElementById("btnAuth")
        .addEventListener("click", (e) => {
          e.preventDefault();
          handleAuth();
        });
      document
        .getElementById("btnLogout")
        .addEventListener("click", (e) => {
          e.preventDefault();
          handleLogout();
        });
      document
        .getElementById("btnReloadFeed")
        .addEventListener("click", (e) => {
          e.preventDefault();
          loadPosts();
        });
      document
        .getElementById("btnClearCache")
        .addEventListener("click", () => {
          localStorage.clear();
          alert("Local cache cleared.");
        });

      document
        .getElementById("feedFilter")
        .addEventListener("change", renderPosts);
      document
        .getElementById("feedSearch")
        .addEventListener("input", renderPosts);

      // auth state
      supabase.auth.onAuthStateChange((event, session) => {
        currentUser = session?.user || null;
        updateAuthUI();
        if (currentUser) {
          loadPosts();
        } else {
          allPosts = [];
          renderPosts();
        }
      });

      // initial user
      const { data } = await supabase.auth.getUser();
      currentUser = data.user || null;
      updateAuthUI();
      if (currentUser) {
        await loadPosts();
      }
    }

    init();
  </script>
</body>
</html>